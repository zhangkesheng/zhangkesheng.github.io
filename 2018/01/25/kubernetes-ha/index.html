<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>部署高可用的k8s集群 | 张克升的个人博客</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">部署高可用的k8s集群</h1><a id="logo" href="/.">张克升的个人博客</a><p class="description">不想当架构师的工程师不是好的程序员</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Search"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">部署高可用的k8s集群</h1><div class="post-meta"><a href="/2018/01/25/kubernetes-ha/#comments" class="comment-count"></a><p><span class="date">Jan 25, 2018</span><span><a href="/categories/Kubernetes/" class="category">Kubernetes</a></span></p></div><div class="post-content"><h1 id="Kubernetes-HA"><a href="#Kubernetes-HA" class="headerlink" title="Kubernetes HA"></a>Kubernetes HA</h1><blockquote>
<p>摘自 <a href="https://rootsongjc.gitbooks.io/kubernetes-handbook/content/practice/install-kbernetes1.6-on-centos.html" target="_blank" rel="external">在CentOS上部署kubernetes1.6集群</a></p>
</blockquote>
<h2 id="创建TLS证书和密钥"><a href="#创建TLS证书和密钥" class="headerlink" title="创建TLS证书和密钥"></a>创建TLS证书和密钥</h2><h3 id="安装CFSSL-源码包安装"><a href="#安装CFSSL-源码包安装" class="headerlink" title="安装CFSSL(源码包安装)"></a>安装CFSSL(源码包安装)</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">wget https://pkg.cfssl.org/R1.2/cfssl_linux-amd64</div><div class="line">chmod +x cfssl_linux-amd64</div><div class="line">mv cfssl_linux-amd64 /usr/local/bin/cfssl</div><div class="line"></div><div class="line">wget https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64</div><div class="line">chmod +x cfssljson_linux-amd64</div><div class="line">mv cfssljson_linux-amd64 /usr/local/bin/cfssljson</div><div class="line"></div><div class="line">wget https://pkg.cfssl.org/R1.2/cfssl-certinfo_linux-amd64</div><div class="line">chmod +x cfssl-certinfo_linux-amd64</div><div class="line">mv cfssl-certinfo_linux-amd64 /usr/local/bin/cfssl-certinfo</div><div class="line"></div><div class="line">export PATH=/usr/local/bin:$PATH</div></pre></td></tr></table></figure>
<h3 id="创建CA"><a href="#创建CA" class="headerlink" title="创建CA"></a>创建CA</h3><h4 id="CA配置文件"><a href="#CA配置文件" class="headerlink" title="CA配置文件"></a>CA配置文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">mkdir /root/ssl</div><div class="line">cd /root/ssl</div><div class="line">cfssl print-defaults config &gt; config.json</div><div class="line">cfssl print-defaults csr &gt; csr.json</div><div class="line"><span class="meta">#</span><span class="bash"> 根据config.json文件的格式创建如下的ca-config.json文件</span></div><div class="line"><span class="meta">#</span><span class="bash"> 过期时间设置成了 87600h</span></div><div class="line">cat &gt; ca-config.json &lt;&lt;EOF</div><div class="line">&#123;</div><div class="line">  "signing": &#123;</div><div class="line">    "default": &#123;</div><div class="line">      "expiry": "87600h"</div><div class="line">    &#125;,</div><div class="line">    "profiles": &#123;</div><div class="line">      "kubernetes": &#123;</div><div class="line">        "usages": [</div><div class="line">            "signing",</div><div class="line">            "key encipherment",</div><div class="line">            "server auth",</div><div class="line">            "client auth"</div><div class="line">        ],</div><div class="line">        "expiry": "87600h"</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">EOF</div></pre></td></tr></table></figure>
<blockquote>
<ul>
<li><code>ca-config.json</code>：可以定义多个 profiles，分别指定不同的过期时间、使用场景等参数；后续在签名证书时使用某个 profile；</li>
<li><code>signing</code>：表示该证书可用于签名其它证书；生成的 ca.pem 证书中 <code>CA=TRUE</code>；</li>
<li><code>server auth</code>：表示client可以用该 CA 对server提供的证书进行验证；</li>
<li><code>client auth</code>：表示server可以用该CA对client提供的证书进行验证；</li>
</ul>
</blockquote>
<h4 id="创建CA证书签名请求"><a href="#创建CA证书签名请求" class="headerlink" title="创建CA证书签名请求"></a>创建CA证书签名请求</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">cat &gt; ca-csr.json &lt;&lt;EOF</div><div class="line">&#123;</div><div class="line">  "CN": "kubernetes",</div><div class="line">  "key": &#123;</div><div class="line">    "algo": "rsa",</div><div class="line">    "size": 2048</div><div class="line">  &#125;,</div><div class="line">  "names": [</div><div class="line">    &#123;</div><div class="line">      "C": "CN",</div><div class="line">      "ST": "BeiJing",</div><div class="line">      "L": "BeiJing",</div><div class="line">      "O": "k8s",</div><div class="line">      "OU": "System"</div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div><div class="line">EOF</div></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>“CN”：<code>Common Name</code>，kube-apiserver 从证书中提取该字段作为请求的用户名 (User Name)；浏览器使用该字段验证网站是否合法；</li>
<li>“O”：<code>Organization</code>，kube-apiserver 从证书中提取该字段作为请求用户所属的组 (Group)；</li>
</ul>
</blockquote>
<h4 id="生成-CA-证书和私钥"><a href="#生成-CA-证书和私钥" class="headerlink" title="生成 CA 证书和私钥"></a>生成 CA 证书和私钥</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> cfssl gencert -initca ca-csr.json | cfssljson -bare ca</span></div><div class="line"><span class="meta">$</span><span class="bash"> ls ca*</span></div><div class="line">ca-config.json  ca.csr  ca-csr.json  ca-key.pem  ca.pem</div></pre></td></tr></table></figure>
<h3 id="创建kubernetes证书"><a href="#创建kubernetes证书" class="headerlink" title="创建kubernetes证书"></a>创建kubernetes证书</h3><h4 id="创建-kubernetes-证书签名请求文件"><a href="#创建-kubernetes-证书签名请求文件" class="headerlink" title="创建 kubernetes 证书签名请求文件"></a>创建 kubernetes 证书签名请求文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">cat kubernetes-csr.json &lt;&lt;EOF</div><div class="line">&#123;</div><div class="line">    "CN": "kubernetes",</div><div class="line">    "hosts": [</div><div class="line">      "127.0.0.1",</div><div class="line">      "172.20.0.112",</div><div class="line">      "172.20.0.113",</div><div class="line">      "172.20.0.114",</div><div class="line">      "172.20.0.115",</div><div class="line">      "10.254.0.1",</div><div class="line">      "kubernetes",</div><div class="line">      "kubernetes.default",</div><div class="line">      "kubernetes.default.svc",</div><div class="line">      "kubernetes.default.svc.cluster",</div><div class="line">      "kubernetes.default.svc.cluster.local"</div><div class="line">    ],</div><div class="line">    "key": &#123;</div><div class="line">        "algo": "rsa",</div><div class="line">        "size": 2048</div><div class="line">    &#125;,</div><div class="line">    "names": [</div><div class="line">        &#123;</div><div class="line">            "C": "CN",</div><div class="line">            "ST": "BeiJing",</div><div class="line">            "L": "BeiJing",</div><div class="line">            "O": "k8s",</div><div class="line">            "OU": "System"</div><div class="line">        &#125;</div><div class="line">    ]</div><div class="line">&#125;</div><div class="line">EOF</div></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>如果 hosts 字段不为空则需要指定授权使用该证书的 <strong>IP 或域名列表</strong>，由于该证书后续被 <code>etcd</code> 集群和 <code>kubernetes master</code> 集群使用，所以上面分别指定了 <code>etcd</code> 集群、<code>kubernetes master</code> 集群的主机 IP 和 <strong>kubernetes 服务的服务 IP</strong>（一般是 <code>kube-apiserver</code> 指定的 <code>service-cluster-ip-range</code> 网段的第一个IP，如 10.254.0.1。</li>
<li>hosts 中的内容可以为空，即使按照上面的配置，向集群中增加新节点后也不需要重新生成证书。</li>
</ul>
</blockquote>
<h4 id="生成-kubernetes-证书和私钥"><a href="#生成-kubernetes-证书和私钥" class="headerlink" title="生成 kubernetes 证书和私钥"></a>生成 kubernetes 证书和私钥</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kubernetes-csr.json | cfssljson -bare kubernetes</span></div><div class="line"><span class="meta">$</span><span class="bash"> ls kubernetes*</span></div><div class="line">kubernetes.csr  kubernetes-csr.json  kubernetes-key.pem  kubernetes.pem</div></pre></td></tr></table></figure>
<h3 id="创建admin证书"><a href="#创建admin证书" class="headerlink" title="创建admin证书"></a>创建admin证书</h3><h4 id="创建-admin-证书签名请求文件"><a href="#创建-admin-证书签名请求文件" class="headerlink" title="创建 admin 证书签名请求文件"></a>创建 admin 证书签名请求文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">cat admin-csr.json &lt;&lt;EOF</div><div class="line">&#123;</div><div class="line">  "CN": "admin",</div><div class="line">  "hosts": [],</div><div class="line">  "key": &#123;</div><div class="line">    "algo": "rsa",</div><div class="line">    "size": 2048</div><div class="line">  &#125;,</div><div class="line">  "names": [</div><div class="line">    &#123;</div><div class="line">      "C": "CN",</div><div class="line">      "ST": "BeiJing",</div><div class="line">      "L": "BeiJing",</div><div class="line">      "O": "system:masters",</div><div class="line">      "OU": "System"</div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div><div class="line">EOF</div></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>后续 <code>kube-apiserver</code> 使用 <code>RBAC</code> 对客户端(如 <code>kubelet</code>、<code>kube-proxy</code>、<code>Pod</code>)请求进行授权；</li>
<li><code>kube-apiserver</code> 预定义了一些 <code>RBAC</code> 使用的 <code>RoleBindings</code>，如 <code>cluster-admin</code> 将 Group <code>system:masters</code> 与 Role <code>cluster-admin</code> 绑定，该 Role 授予了调用<code>kube-apiserver</code> 的<strong>所有 API</strong>的权限；</li>
<li>OU 指定该证书的 Group 为 <code>system:masters</code>，<code>kubelet</code> 使用该证书访问 <code>kube-apiserver</code> 时 ，由于证书被 CA 签名，所以认证通过，同时由于证书用户组为经过预授权的 <code>system:masters</code>，所以被授予访问所有 API 的权限；</li>
</ul>
</blockquote>
<h4 id="生成-admin-证书和私钥"><a href="#生成-admin-证书和私钥" class="headerlink" title="生成 admin 证书和私钥"></a>生成 admin 证书和私钥</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin</span></div><div class="line"><span class="meta">$</span><span class="bash"> ls admin*</span></div><div class="line">admin.csr  admin-csr.json  admin-key.pem  admin.pem</div></pre></td></tr></table></figure>
<h3 id="创建-kube-proxy-证书"><a href="#创建-kube-proxy-证书" class="headerlink" title="创建 kube-proxy 证书"></a>创建 kube-proxy 证书</h3><h4 id="创建kube-proxy证书签名请求文件"><a href="#创建kube-proxy证书签名请求文件" class="headerlink" title="创建kube-proxy证书签名请求文件"></a>创建kube-proxy证书签名请求文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">cat kube-proxy-csr.json &lt;&lt;EOF</div><div class="line">&#123;</div><div class="line">  "CN": "system:kube-proxy",</div><div class="line">  "hosts": [],</div><div class="line">  "key": &#123;</div><div class="line">    "algo": "rsa",</div><div class="line">    "size": 2048</div><div class="line">  &#125;,</div><div class="line">  "names": [</div><div class="line">    &#123;</div><div class="line">      "C": "CN",</div><div class="line">      "ST": "BeiJing",</div><div class="line">      "L": "BeiJing",</div><div class="line">      "O": "k8s",</div><div class="line">      "OU": "System"</div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div><div class="line">EOF</div></pre></td></tr></table></figure>
<h4 id="生成-kube-proxy-客户端证书和私钥"><a href="#生成-kube-proxy-客户端证书和私钥" class="headerlink" title="生成 kube-proxy 客户端证书和私钥"></a>生成 kube-proxy 客户端证书和私钥</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">$</span><span class="bash"> cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes  kube-proxy-csr.json | cfssljson -bare kube-proxy</span></div><div class="line"><span class="meta">$</span><span class="bash"> ls kube-proxy*</span></div><div class="line">kube-proxy.csr  kube-proxy-csr.json  kube-proxy-key.pem  kube-proxy.pem</div></pre></td></tr></table></figure>
<h3 id="校验证书"><a href="#校验证书" class="headerlink" title="校验证书"></a>校验证书</h3><h4 id="opsnssl"><a href="#opsnssl" class="headerlink" title="opsnssl"></a>opsnssl</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">openssl x509  -noout -text -in  kubernetes.pem</div></pre></td></tr></table></figure>
<h3 id="cfssl-certinfo"><a href="#cfssl-certinfo" class="headerlink" title="cfssl-certinfo"></a>cfssl-certinfo</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cfssl-certinfo -cert kubernetes.pem</div></pre></td></tr></table></figure>
<h3 id="分发证书"><a href="#分发证书" class="headerlink" title="分发证书"></a>分发证书</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mkdir -p /etc/kubernetes/ssl</div><div class="line">cp *.pem /etc/kubernetes/ssl</div></pre></td></tr></table></figure>
<h2 id="安装kubectl命令行工具"><a href="#安装kubectl命令行工具" class="headerlink" title="安装kubectl命令行工具"></a>安装kubectl命令行工具</h2><h3 id="下载-kubectl"><a href="#下载-kubectl" class="headerlink" title="下载 kubectl"></a>下载 kubectl</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">wget https://dl.k8s.io/v1.8.4/kubernetes-client-linux-amd64.tar.gz</div><div class="line">tar -xzvf kubernetes-client-linux-amd64.tar.gz</div><div class="line">cp kubernetes/client/bin/kube* /usr/bin/</div><div class="line">chmod a+x /usr/bin/kube*</div></pre></td></tr></table></figure>
<h2 id="创建kubeconfig文件"><a href="#创建kubeconfig文件" class="headerlink" title="创建kubeconfig文件"></a>创建kubeconfig文件</h2><h3 id="创建TLS-Bootsrapping-Token"><a href="#创建TLS-Bootsrapping-Token" class="headerlink" title="创建TLS Bootsrapping Token"></a>创建TLS Bootsrapping Token</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">export BOOTSTRAP_TOKEN=$(head -c 16 /dev/urandom | od -An -t x | tr -d ' ')</div><div class="line">cat &gt; /etc/kubernetes/token.csv &lt;&lt;EOF</div><div class="line"><span class="meta">$</span><span class="bash">&#123;BOOTSTRAP_TOKEN&#125;,kubelet-bootstrap,10001,<span class="string">"system:kubelet-bootstrap"</span></span></div><div class="line">EOF</div></pre></td></tr></table></figure>
<h3 id="创建-kubelet-bootstrapping-kubeconfig-文件"><a href="#创建-kubelet-bootstrapping-kubeconfig-文件" class="headerlink" title="创建 kubelet bootstrapping kubeconfig 文件"></a>创建 kubelet bootstrapping kubeconfig 文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">cd /etc/kubernetes</div><div class="line">export KUBE_APISERVER="https://192.168.10.56:6443"</div><div class="line"><span class="meta">#</span><span class="bash"> 设置集群参数</span></div><div class="line">kubectl config set-cluster kubernetes \</div><div class="line">  --certificate-authority=/etc/kubernetes/ssl/ca.pem \</div><div class="line">  --embed-certs=true \</div><div class="line">  --server=$&#123;KUBE_APISERVER&#125; \</div><div class="line">  --kubeconfig=bootstrap.kubeconfig</div><div class="line"></div><div class="line"><span class="meta">#</span><span class="bash"> 设置客户端认证参数</span></div><div class="line">kubectl config set-credentials kubelet-bootstrap \</div><div class="line">  --token=$&#123;BOOTSTRAP_TOKEN&#125; \</div><div class="line">  --kubeconfig=bootstrap.kubeconfig</div><div class="line"></div><div class="line"><span class="meta">#</span><span class="bash"> 设置上下文参数</span></div><div class="line">kubectl config set-context default \</div><div class="line">  --cluster=kubernetes \</div><div class="line">  --user=kubelet-bootstrap \</div><div class="line">  --kubeconfig=bootstrap.kubeconfig</div><div class="line"></div><div class="line"><span class="meta">#</span><span class="bash"> 设置默认上下文</span></div><div class="line">kubectl config use-context default --kubeconfig=bootstrap.kubeconfig</div></pre></td></tr></table></figure>
<blockquote>
<ul>
<li><code>--embed-certs</code> 为 <code>true</code> 时表示将 <code>certificate-authority</code> 证书写入到生成的 <code>bootstrap.kubeconfig</code> 文件中.</li>
</ul>
<ul>
<li>设置客户端认证参数时<strong>没有</strong>指定秘钥和证书, 后续由 <code>kube-apiserver</code> 自动生成.</li>
</ul>
</blockquote>
<h3 id="创建-kube-proxy-kubeconfig-文件"><a href="#创建-kube-proxy-kubeconfig-文件" class="headerlink" title="创建 kube-proxy kubeconfig 文件"></a>创建 kube-proxy kubeconfig 文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> 设置集群参数</span></div><div class="line">kubectl config set-cluster kubernetes \</div><div class="line">  --certificate-authority=/etc/kubernetes/ssl/ca.pem \</div><div class="line">  --embed-certs=true \</div><div class="line">  --server=$&#123;KUBE_APISERVER&#125; \</div><div class="line">  --kubeconfig=kube-proxy.kubeconfig</div><div class="line"><span class="meta">#</span><span class="bash"> 设置客户端认证参数</span></div><div class="line">kubectl config set-credentials kube-proxy \</div><div class="line">  --client-certificate=/etc/kubernetes/ssl/kube-proxy.pem \</div><div class="line">  --client-key=/etc/kubernetes/ssl/kube-proxy-key.pem \</div><div class="line">  --embed-certs=true \</div><div class="line">  --kubeconfig=kube-proxy.kubeconfig</div><div class="line"><span class="meta">#</span><span class="bash"> 设置上下文参数</span></div><div class="line">kubectl config set-context default \</div><div class="line">  --cluster=kubernetes \</div><div class="line">  --user=kube-proxy \</div><div class="line">  --kubeconfig=kube-proxy.kubeconfig</div><div class="line"><span class="meta">#</span><span class="bash"> 设置默认上下文</span></div><div class="line">kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</div></pre></td></tr></table></figure>
<p>若上述操作不是在<code>/etc/kubernetes</code>中执行, 则需要将生成文件cp到<code>/etc/kubernetes</code>中.</p>
<h2 id="Etcd集群"><a href="#Etcd集群" class="headerlink" title="Etcd集群"></a>Etcd集群</h2><h3 id="下载并安装etcd"><a href="#下载并安装etcd" class="headerlink" title="下载并安装etcd"></a>下载并安装etcd</h3><p>TLS证书沿用kubernetes证书, 如有需要, 可按<a href="#1">创建TLS证书和密钥</a> </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">wget https://github.com/coreos/etcd/releases/download/v3.2.10/etcd-v3.2.10-linux-amd64.tar.gz</div><div class="line">tar -xvf etcd-v3.2.10-linux-amd64.tar.gz</div><div class="line">mv etcd-v3.2.10-linux-amd64/etcd* /usr/local/bin</div></pre></td></tr></table></figure>
<p>或者直接拷贝其他主机的证书</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">scp root@192.168.10.56:/etc/kubernetes/ssl/* /etc/kubernetes/ssl/</div></pre></td></tr></table></figure>
<h3 id="创建-etcd-的systamd-unit-文件"><a href="#创建-etcd-的systamd-unit-文件" class="headerlink" title="创建 etcd 的systamd unit 文件"></a>创建 etcd 的systamd unit 文件</h3><p><code>/etc/systemd/system/etcd.service</code>, 注意替换IP地址为你自己的etcd集群的主机IP.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">[Unit]</div><div class="line">Description=Etcd Server</div><div class="line">After=network.target</div><div class="line">After=network-online.target</div><div class="line">Wants=network-online.target</div><div class="line">Documentation=https://github.com/coreos</div><div class="line"></div><div class="line">[Service]</div><div class="line">Type=notify</div><div class="line">WorkingDirectory=/var/lib/etcd/</div><div class="line">EnvironmentFile=-/etc/etcd/etcd.conf</div><div class="line">ExecStart=/usr/local/bin/etcd \</div><div class="line">  --name $&#123;ETCD_NAME&#125; \</div><div class="line">  --cert-file=/etc/kubernetes/ssl/kubernetes.pem \</div><div class="line">  --key-file=/etc/kubernetes/ssl/kubernetes-key.pem \</div><div class="line">  --peer-cert-file=/etc/kubernetes/ssl/kubernetes.pem \</div><div class="line">  --peer-key-file=/etc/kubernetes/ssl/kubernetes-key.pem \</div><div class="line">  --trusted-ca-file=/etc/kubernetes/ssl/ca.pem \</div><div class="line">  --peer-trusted-ca-file=/etc/kubernetes/ssl/ca.pem \</div><div class="line">  --initial-advertise-peer-urls $&#123;ETCD_INITIAL_ADVERTISE_PEER_URLS&#125; \</div><div class="line">  --listen-peer-urls $&#123;ETCD_LISTEN_PEER_URLS&#125; \</div><div class="line">  --listen-client-urls $&#123;ETCD_LISTEN_CLIENT_URLS&#125;,https://127.0.0.1:2379 \</div><div class="line">  --advertise-client-urls $&#123;ETCD_ADVERTISE_CLIENT_URLS&#125; \</div><div class="line">  --initial-cluster-token $&#123;ETCD_INITIAL_CLUSTER_TOKEN&#125; \</div><div class="line">  --initial-cluster infra1=https://192.168.10.56:2380,infra2=https://192.168.10.57:2380,infra3=https://192.168.10.58:2380 \</div><div class="line">  --initial-cluster-state new \</div><div class="line">  --data-dir=$&#123;ETCD_DATA_DIR&#125;</div><div class="line">Restart=on-failure</div><div class="line">RestartSec=5</div><div class="line">LimitNOFILE=65536</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div></pre></td></tr></table></figure>
<blockquote>
<p>指定 <code>etcd</code> 的工作目录为 <code>/var/lib/etcd</code>,数据目录为 <code>/var/lib/etcd</code>,需在启动服务前创建这两个目录.</p>
</blockquote>
<p>环境变量配置文件<code>/etc/etcd/etcd.conf</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">cat &gt; /etc/etcd/etcd.conf &lt;&lt;EOF</div><div class="line"><span class="meta">#</span><span class="bash"> [member]</span></div><div class="line">ETCD_NAME=infra1</div><div class="line">ETCD_DATA_DIR="/var/lib/etcd"</div><div class="line">ETCD_LISTEN_PEER_URLS="https://192.168.10.57:2380"</div><div class="line">ETCD_LISTEN_CLIENT_URLS="https://192.168.10.57:2379"</div><div class="line"></div><div class="line"><span class="meta">#</span><span class="bash">[cluster]</span></div><div class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS="https://192.168.10.57:2380"</div><div class="line">ETCD_INITIAL_CLUSTER_TOKEN="etcd-cluster"</div><div class="line">ETCD_ADVERTISE_CLIENT_URLS="https://192.168.10.57:2379"</div><div class="line">EOF</div></pre></td></tr></table></figure>
<blockquote>
<p>在另外的主机上添加同样的文件, 对应的IP改为主机IP, ETCD_NAME也相应修改.</p>
</blockquote>
<h3 id="启动-etcd-服务"><a href="#启动-etcd-服务" class="headerlink" title="启动 etcd 服务"></a>启动 etcd 服务</h3><p><strong>启动之前, 需要配置防火墙, 否则可能会出现connect refused问题</strong> </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ufw allow from 192.168.10.56</div><div class="line">ufw allow from 192.168.10.57</div><div class="line">ufw allow from 192.168.10.58</div></pre></td></tr></table></figure>
<p> 启动etcd服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">systemctl daemon-reload</div><div class="line">systemctl enable etcd</div><div class="line">systemctl start etcd</div><div class="line">systemctl status etcd</div></pre></td></tr></table></figure>
<p>在其他主机上执行上述安装, 配置操作, 启动所有主机上的etcd服务.</p>
<h3 id="验证服务"><a href="#验证服务" class="headerlink" title="验证服务"></a>验证服务</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">etcdctl \</div><div class="line">  --ca-file=/etc/kubernetes/ssl/ca.pem \</div><div class="line">  --cert-file=/etc/kubernetes/ssl/kubernetes.pem \</div><div class="line">  --key-file=/etc/kubernetes/ssl/kubernetes-key.pem \</div><div class="line">  cluster-health</div></pre></td></tr></table></figure>
<p>如果直接执行上述命令出现如下错误:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">cluster may be unhealthy: failed to list members</div><div class="line">Error:  client: etcd cluster is unavailable or misconfigured; error #0: malformed HTTP response &quot;\x15\x03\x01\x00\x02\x02&quot;</div><div class="line">; error #1: dial tcp 127.0.0.1:4001: getsockopt: connection refused</div></pre></td></tr></table></figure>
<p>执行<code>export ETCDCTL_ENDPOINT=https://127.0.0.1:2379</code>修改ETCDCTL_ENDPOINT环境变量, 之后再次执行, 则可以看到结果.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">member 8f573ae51eacb66 is healthy: got healthy result from https://192.168.10.57:2379</div><div class="line">member 42c120089619ad70 is healthy: got healthy result from https://192.168.10.58:2379</div><div class="line">member 6bc3e880c7cf3ed7 is healthy: got healthy result from https://192.168.10.56:2379</div><div class="line">cluster is healthy</div></pre></td></tr></table></figure>
<p>结果最后一行为 <code>cluster is healthy</code> 时表示集群服务正常.</p>
<p>若是出现member配置错误, 修改配置重新执行前, 需要删除<code>/var/lib/etcd/member</code>文件夹</p>
<p>PS: 若有个坑货在你部署的时候乱弄你的服务器, 可能会导致etcd member健康检查成功, 但主机上的etcd也创建成功, 但是连接不上集群. 暂时只想到重新启动所有etcd服务的解决方法:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span><span class="bash"> 停止并删除工作目录的member文件夹</span></div><div class="line">systemctl stop etcd.service</div><div class="line">systemctl disable etcd.service</div><div class="line">rm -r /var/lib/etcd/member/</div><div class="line"><span class="meta">#</span><span class="bash"> 重新启动etcd集群</span></div><div class="line">systemctl daemon-reload</div><div class="line">systemctl enable etcd</div><div class="line">systemctl start etcd</div><div class="line">systemctl status etcd</div></pre></td></tr></table></figure>
<h2 id="部署master集群"><a href="#部署master集群" class="headerlink" title="部署master集群"></a>部署master集群</h2><p>安装kubernetes</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">wget https://dl.k8s.io/v1.8.4/kubernetes-server-linux-amd64.tar.gz</div><div class="line">tar -xzvf kubernetes-server-linux-amd64.tar.gz</div><div class="line">cp -r kubernetes/server/bin/&#123;kube-apiserver,kube-controller-manager,kube-scheduler,kubectl,kube-proxy,kubelet&#125; /usr/local/bin/</div></pre></td></tr></table></figure>
<p>关闭swap</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">swapoff -a</div></pre></td></tr></table></figure>
<p>docker代理, 所以需要设置docker的代理</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">mkdir -p /etc/systemd/system/docker.service.d</div><div class="line">cat &gt; /etc/systemd/system/docker.service.d/http-proxy.conf &lt;&lt; EOF</div><div class="line">[Service]</div><div class="line">Environment="HTTP_PROXY=http://192.168.32.10:6780"</div><div class="line">Environment="HTTPS_PROXY=http://192.168.32.10:6780"</div><div class="line">Environment="NO_PROXY=.aliyun.com,.aliyuncs.com,.daocloud.io,.cn,localhost"</div><div class="line">EOF</div></pre></td></tr></table></figure>
<blockquote>
<p>note: no_proxy不支持通配符</p>
</blockquote>
<h2 id="部署master节点"><a href="#部署master节点" class="headerlink" title="部署master节点"></a>部署master节点</h2><p>证书上述已经创建好, 可直接使用</p>
<h3 id="下载最新版二进制文件"><a href="#下载最新版二进制文件" class="headerlink" title="下载最新版二进制文件"></a>下载最新版二进制文件</h3><p>从 <a href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG.md" target="_blank" rel="external"><code>CHANGELOG</code>页面</a> 下载 <code>client</code> 或 <code>server</code> tarball 文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">wget https://dl.k8s.io/v1.8.4/kubernetes-server-linux-amd64.tar.gz</div><div class="line">tar -xzvf kubernetes-server-linux-amd64.tar.gz</div><div class="line">cd kubernetes</div><div class="line">tar -xzvf  kubernetes-src.tar.gz</div><div class="line"><span class="meta">#</span><span class="bash">将二进制文件拷贝到指定路径</span></div><div class="line">cp -r server/bin/&#123;kube-apiserver,kube-controller-manager,kube-scheduler,kubectl,kube-proxy,kubelet&#125; /usr/local/bin/</div></pre></td></tr></table></figure>
<h3 id="配置和启动kube-apiserver"><a href="#配置和启动kube-apiserver" class="headerlink" title="配置和启动kube-apiserver"></a>配置和启动kube-apiserver</h3><p>创建kube-apiserver的service配置文件<code>/etc/systemd/system/kube-apiserver.service</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">[Unit]</div><div class="line">Description=Kubernetes API Service</div><div class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</div><div class="line">After=network.target</div><div class="line">After=etcd.service</div><div class="line"></div><div class="line">[Service]</div><div class="line">EnvironmentFile=-/etc/kubernetes/config</div><div class="line">EnvironmentFile=-/etc/kubernetes/apiserver</div><div class="line">ExecStart=/usr/local/bin/kube-apiserver \</div><div class="line">        $KUBE_LOGTOSTDERR \</div><div class="line">        $KUBE_LOG_LEVEL \</div><div class="line">        $KUBE_ETCD_SERVERS \</div><div class="line">        $KUBE_API_ADDRESS \</div><div class="line">        $KUBE_API_PORT \</div><div class="line">        $KUBELET_PORT \</div><div class="line">        $KUBE_ALLOW_PRIV \</div><div class="line">        $KUBE_SERVICE_ADDRESSES \</div><div class="line">        $KUBE_ADMISSION_CONTROL \</div><div class="line">        $KUBE_API_ARGS</div><div class="line">Restart=on-failure</div><div class="line">Type=notify</div><div class="line">LimitNOFILE=65536</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div></pre></td></tr></table></figure>
<p>/etc/kubernetes/config:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">cat &gt; /etc/kubernetes/config &lt;&lt;EOF</div><div class="line"><span class="meta">#</span><span class="bash"><span class="comment">##</span></span></div><div class="line"><span class="meta">#</span><span class="bash"> kubernetes system config</span></div><div class="line"><span class="meta">#</span><span class="bash"></span></div><div class="line"><span class="meta">#</span><span class="bash"> The following values are used to configure various aspects of all</span></div><div class="line"><span class="meta">#</span><span class="bash"> kubernetes services, including</span></div><div class="line"><span class="meta">#</span><span class="bash"></span></div><div class="line"><span class="meta">#</span><span class="bash">   kube-apiserver.service</span></div><div class="line"><span class="meta">#</span><span class="bash">   kube-controller-manager.service</span></div><div class="line"><span class="meta">#</span><span class="bash">   kube-scheduler.service</span></div><div class="line"><span class="meta">#</span><span class="bash">   kubelet.service</span></div><div class="line"><span class="meta">#</span><span class="bash">   kube-proxy.service</span></div><div class="line"><span class="meta">#</span><span class="bash"> logging to stderr means we get it <span class="keyword">in</span> the systemd journal</span></div><div class="line">KUBE_LOGTOSTDERR="--logtostderr=true"</div><div class="line"></div><div class="line"><span class="meta">#</span><span class="bash"> journal message level, 0 is debug</span></div><div class="line">KUBE_LOG_LEVEL="--v=0"</div><div class="line"></div><div class="line"><span class="meta">#</span><span class="bash"> Should this cluster be allowed to run privileged docker containers</span></div><div class="line">KUBE_ALLOW_PRIV="--allow-privileged=true"</div><div class="line"></div><div class="line"><span class="meta">#</span><span class="bash"> How the controller-manager, scheduler, and proxy find the apiserver</span></div><div class="line"><span class="meta">#</span><span class="bash">KUBE_MASTER=<span class="string">"--master=http://sz-pg-oam-docker-test-001.tendcloud.com:8080"</span></span></div><div class="line">KUBE_MASTER="--master=http://192.168.10.58:8080"</div><div class="line">EOF</div></pre></td></tr></table></figure>
<blockquote>
<p>该配置文件同时被kube-apiserver, kube-controller-manager, kube-scheduler, kubelet, kube-proxy使用.</p>
</blockquote>
<p>apiserver配置文件<code>/etc/kubernetes/apiserver</code>内容为:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">cat &gt; /etc/kubernetes/apiserver &lt;&lt;EOF</div><div class="line"><span class="meta">#</span><span class="bash"><span class="comment">##</span></span></div><div class="line"><span class="meta">#</span><span class="bash"><span class="comment"># kubernetes system config</span></span></div><div class="line"><span class="meta">#</span><span class="bash"><span class="comment">#</span></span></div><div class="line"><span class="meta">#</span><span class="bash"><span class="comment"># The following values are used to configure the kube-apiserver</span></span></div><div class="line"><span class="meta">#</span><span class="bash"><span class="comment">#</span></span></div><div class="line"><span class="meta">#</span><span class="bash"></span></div><div class="line"><span class="meta">#</span><span class="bash"><span class="comment"># The address on the local server to listen to.</span></span></div><div class="line"><span class="meta">#</span><span class="bash">KUBE_API_ADDRESS=<span class="string">"--insecure-bind-address=sz-pg-oam-docker-test-001.tendcloud.com"</span></span></div><div class="line">KUBE_API_ADDRESS="--advertise-address=192.168.10.58 --bind-address=192.168.10.58 --insecure-bind-address=192.168.10.58"</div><div class="line"><span class="meta">#</span><span class="bash"></span></div><div class="line"><span class="meta">#</span><span class="bash"><span class="comment"># The port on the local server to listen on.</span></span></div><div class="line"><span class="meta">#</span><span class="bash">KUBE_API_PORT=<span class="string">"--port=8080"</span></span></div><div class="line"><span class="meta">#</span><span class="bash"></span></div><div class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Port minions listen on</span></span></div><div class="line"><span class="meta">#</span><span class="bash">KUBELET_PORT=<span class="string">"--kubelet-port=10250"</span></span></div><div class="line"><span class="meta">#</span><span class="bash"></span></div><div class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Comma separated list of nodes in the etcd cluster</span></span></div><div class="line">KUBE_ETCD_SERVERS="--etcd-servers=https://192.168.10.56:2379,https://192.168.10.57:2379,https://192.168.10.58:2379"</div><div class="line"><span class="meta">#</span><span class="bash"></span></div><div class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Address range to use for services</span></span></div><div class="line">KUBE_SERVICE_ADDRESSES="--service-cluster-ip-range=10.254.0.0/16"</div><div class="line"><span class="meta">#</span><span class="bash"></span></div><div class="line"><span class="meta">#</span><span class="bash"><span class="comment"># default admission control policies</span></span></div><div class="line">KUBE_ADMISSION_CONTROL="--admission-control=ServiceAccount,NamespaceLifecycle,NamespaceExists,LimitRanger,ResourceQuota"</div><div class="line"><span class="meta">#</span><span class="bash"></span></div><div class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Add your own!</span></span></div><div class="line">KUBE_API_ARGS="--authorization-mode=RBAC --runtime-config=rbac.authorization.k8s.io/v1beta1 --kubelet-https=true --experimental-bootstrap-token-auth --token-auth-file=/etc/kubernetes/token.csv --service-node-port-range=30000-32767 --tls-cert-file=/etc/kubernetes/ssl/kubernetes.pem --tls-private-key-file=/etc/kubernetes/ssl/kubernetes-key.pem --client-ca-file=/etc/kubernetes/ssl/ca.pem --service-account-key-file=/etc/kubernetes/ssl/ca-key.pem --etcd-cafile=/etc/kubernetes/ssl/ca.pem --etcd-certfile=/etc/kubernetes/ssl/kubernetes.pem --etcd-keyfile=/etc/kubernetes/ssl/kubernetes-key.pem --enable-swagger-ui=true --apiserver-count=3 --audit-log-maxage=30 --audit-log-maxbackup=3 --audit-log-maxsize=100 --audit-log-path=/var/lib/audit.log --event-ttl=1h"</div><div class="line">EOF</div></pre></td></tr></table></figure>
<blockquote>
<ul>
<li><code>--admission-control</code> 值必须包含 <code>ServiceAccount</code></li>
<li><code>--bind-address</code> 不能为 <code>127.0.0.1</code></li>
</ul>
</blockquote>
<h4 id="启动kube-apiserver"><a href="#启动kube-apiserver" class="headerlink" title="启动kube-apiserver"></a>启动kube-apiserver</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">systemctl daemon-reload</div><div class="line">systemctl enable kube-apiserver</div><div class="line">systemctl start kube-apiserver</div><div class="line">systemctl status kube-apiserver</div></pre></td></tr></table></figure>
<h3 id="配置和启动-kube-controller-manager"><a href="#配置和启动-kube-controller-manager" class="headerlink" title="配置和启动 kube-controller-manager"></a>配置和启动 kube-controller-manager</h3><h4 id="创建-kube-controller-manager的serivce配置文件"><a href="#创建-kube-controller-manager的serivce配置文件" class="headerlink" title="创建 kube-controller-manager的serivce配置文件"></a>创建 kube-controller-manager的serivce配置文件</h4><p>service配置文件<code>/etc/systemd/system/kube-controller-manager.service</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">[Unit]</div><div class="line">Description=Kubernetes Controller Manager</div><div class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</div><div class="line"></div><div class="line">[Service]</div><div class="line">EnvironmentFile=-/etc/kubernetes/config</div><div class="line">EnvironmentFile=-/etc/kubernetes/controller-manager</div><div class="line">ExecStart=/usr/local/bin/kube-controller-manager \</div><div class="line">        $KUBE_LOGTOSTDERR \</div><div class="line">        $KUBE_LOG_LEVEL \</div><div class="line">        $KUBE_MASTER \</div><div class="line">        $KUBE_CONTROLLER_MANAGER_ARGS</div><div class="line">Restart=on-failure</div><div class="line">LimitNOFILE=65536</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div></pre></td></tr></table></figure>
<p>配置文件<code>/etc/kubernetes/controller-manager</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">cat &gt; /etc/kubernetes/controller-manager &lt;&lt;EOF</div><div class="line"><span class="meta">#</span><span class="bash"><span class="comment">##</span></span></div><div class="line"><span class="meta">#</span><span class="bash"> The following values are used to configure the kubernetes controller-manager</span></div><div class="line"></div><div class="line"><span class="meta">#</span><span class="bash"> defaults from config and apiserver should be adequate</span></div><div class="line"></div><div class="line"><span class="meta">#</span><span class="bash"> Add your own!</span></div><div class="line">KUBE_CONTROLLER_MANAGER_ARGS="--address=127.0.0.1 --service-cluster-ip-range=10.254.0.0/16 --cluster-name=kubernetes --cluster-signing-cert-file=/etc/kubernetes/ssl/ca.pem --cluster-signing-key-file=/etc/kubernetes/ssl/ca-key.pem  --service-account-private-key-file=/etc/kubernetes/ssl/ca-key.pem --root-ca-file=/etc/kubernetes/ssl/ca.pem --leader-elect=true"</div><div class="line">EOF</div></pre></td></tr></table></figure>
<h4 id="启动-kube-controller-manager"><a href="#启动-kube-controller-manager" class="headerlink" title="启动 kube-controller-manager"></a>启动 kube-controller-manager</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">systemctl daemon-reload</div><div class="line">systemctl enable kube-controller-manager</div><div class="line">systemctl start kube-controller-manager</div></pre></td></tr></table></figure>
<h3 id="配置和启动-kube-scheduler"><a href="#配置和启动-kube-scheduler" class="headerlink" title="配置和启动 kube-scheduler"></a>配置和启动 kube-scheduler</h3><h4 id="创建-kube-scheduler的serivce配置文件"><a href="#创建-kube-scheduler的serivce配置文件" class="headerlink" title="创建 kube-scheduler的serivce配置文件"></a>创建 kube-scheduler的serivce配置文件</h4><p>serivce文件<code>/etc/systemd/system/kube-scheduler.service</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">[Unit]</div><div class="line">Description=Kubernetes Scheduler Plugin</div><div class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</div><div class="line"></div><div class="line">[Service]</div><div class="line">EnvironmentFile=-/etc/kubernetes/config</div><div class="line">EnvironmentFile=-/etc/kubernetes/scheduler</div><div class="line">ExecStart=/usr/local/bin/kube-scheduler \</div><div class="line">            $KUBE_LOGTOSTDERR \</div><div class="line">            $KUBE_LOG_LEVEL \</div><div class="line">            $KUBE_MASTER \</div><div class="line">            $KUBE_SCHEDULER_ARGS</div><div class="line">Restart=on-failure</div><div class="line">LimitNOFILE=65536</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div></pre></td></tr></table></figure>
<p>配置文件<code>/etc/kubernetes/scheduler</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">cat &gt; /etc/kubernetes/scheduler &lt;&lt;EOF</div><div class="line"><span class="meta">#</span><span class="bash"><span class="comment">##</span></span></div><div class="line"><span class="meta">#</span><span class="bash"> kubernetes scheduler config</span></div><div class="line"></div><div class="line"><span class="meta">#</span><span class="bash"> default config should be adequate</span></div><div class="line"></div><div class="line"><span class="meta">#</span><span class="bash"> Add your own!</span></div><div class="line">KUBE_SCHEDULER_ARGS="--leader-elect=true --address=127.0.0.1"</div><div class="line">EOF</div></pre></td></tr></table></figure>
<blockquote>
<p><code>--address</code> 值必须为 <code>127.0.0.1</code>，因为当前 kube-apiserver 期望 scheduler 和 controller-manager 在同一台机器</p>
</blockquote>
<h4 id="启动-kube-scheduler"><a href="#启动-kube-scheduler" class="headerlink" title="启动 kube-scheduler"></a>启动 kube-scheduler</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">systemctl daemon-reload</div><div class="line">systemctl enable kube-scheduler</div><div class="line">systemctl start kube-scheduler</div></pre></td></tr></table></figure>
<h3 id="验证-master-节点功能"><a href="#验证-master-节点功能" class="headerlink" title="验证 master 节点功能"></a>验证 master 节点功能</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ kubectl get componentstatuses</div><div class="line">NAME                 STATUS    MESSAGE              ERROR</div><div class="line">scheduler            Healthy   ok                   </div><div class="line">controller-manager   Healthy   ok                   </div><div class="line">etcd-0               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;   </div><div class="line">etcd-1               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;   </div><div class="line">etcd-2               Healthy   &#123;&quot;health&quot;: &quot;true&quot;&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>若出现<code>The connection to the server localhost:8080 was refused - did you specify the right host or port?</code>错误, 请运行<code>kubectl --server=192.168.10.56:8080 get componentstatuses</code>, 自行修改为主机IP.</p>
<p>apiserver不要指定–insecure-bind-address, 则不会出现上述问题.</p>
</blockquote>
<p>之后再另外两台主机上启动apiserver, controller-maneger, scheduler.</p>
<p><strong>记得<code>cp /etc/kubernetes/token.csv</code></strong></p>
<h2 id="部署node节点"><a href="#部署node节点" class="headerlink" title="部署node节点"></a>部署node节点</h2><h3 id="基础配置"><a href="#基础配置" class="headerlink" title="基础配置"></a>基础配置</h3><p>检查前几部生成的ca文件, 及config文件是否都有.</p>
<h3 id="安装网络插件Flanneld-可跳过"><a href="#安装网络插件Flanneld-可跳过" class="headerlink" title="安装网络插件Flanneld(可跳过)"></a>安装网络插件Flanneld(可跳过)</h3><p>下载二进制文件</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">wget https://github.com/coreos/flannel/releases/download/v0.9.1/flannel-v0.9.1-linux-amd64.tar.gz</div><div class="line">tar -xzvf flannel-v0.9.1-linux-amd64.tar.gz</div><div class="line">cp flanneld /usr/bin/</div></pre></td></tr></table></figure>
<p><code>/etc/systemd/system/flanneld.service</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">[Unit]</div><div class="line">Description=Flanneld overlay address etcd agent</div><div class="line">After=network.target</div><div class="line">After=network-online.target</div><div class="line">Wants=network-online.target</div><div class="line">After=etcd.service</div><div class="line">Before=docker.service</div><div class="line"></div><div class="line">[Service]</div><div class="line">Type=notify</div><div class="line">EnvironmentFile=/etc/sysconfig/flanneld</div><div class="line">EnvironmentFile=-/etc/sysconfig/docker-network</div><div class="line">ExecStart=/usr/bin/flanneld \</div><div class="line">  -etcd-endpoints=$&#123;ETCD_ENDPOINTS&#125; \</div><div class="line">  -etcd-prefix=$&#123;ETCD_PREFIX&#125; \</div><div class="line"><span class="meta">  $</span><span class="bash">FLANNEL_OPTIONS</span></div><div class="line">ExecStartPost=/usr/libexec/flannel/mk-docker-opts.sh -k DOCKER_NETWORK_OPTIONS -d /run/flannel/docker</div><div class="line">Restart=on-failure</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div><div class="line">RequiredBy=docker.service</div></pre></td></tr></table></figure>
<p><code>/etc/sysconfig/flanneld</code>配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">mkdir /etc/sysconfig</div><div class="line">cat &gt; /etc/sysconfig/flanneld &lt;&lt;EOF</div><div class="line"># Flanneld configuration options  </div><div class="line"></div><div class="line"># etcd url location.  Point this to the server where etcd runs</div><div class="line">ETCD_ENDPOINTS=&quot;https://192.168.10.56:2379,https://192.168.10.57:2379,https://192.168.10.58:2379&quot;</div><div class="line"></div><div class="line"># etcd config key.  This is the configuration key that flannel queries</div><div class="line"># For address range assignment</div><div class="line">ETCD_PREFIX=&quot;/kube-centos/network&quot;</div><div class="line"></div><div class="line"># Any additional options that you want to pass</div><div class="line">FLANNEL_OPTIONS=&quot;-etcd-cafile=/etc/kubernetes/ssl/ca.pem -etcd-certfile=/etc/kubernetes/ssl/kubernetes.pem -etcd-keyfile=/etc/kubernetes/ssl/kubernetes-key.pem&quot;</div><div class="line">EOF</div></pre></td></tr></table></figure>
<h4 id="在etcd中创建网络配置"><a href="#在etcd中创建网络配置" class="headerlink" title="在etcd中创建网络配置"></a>在etcd中创建网络配置</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">etcdctl --endpoints=https://192.168.10.56:2379,https://192.168.10.57:2379,https://192.168.10.558:2379 \</div><div class="line">  --ca-file=/etc/kubernetes/ssl/ca.pem \</div><div class="line">  --cert-file=/etc/kubernetes/ssl/kubernetes.pem \</div><div class="line">  --key-file=/etc/kubernetes/ssl/kubernetes-key.pem \</div><div class="line">  mkdir /kube-centos/network</div><div class="line">etcdctl --endpoints=https://192.168.10.56:2379,https://192.168.10.57:2379,https://192.168.10.558:2379 \</div><div class="line">  --ca-file=/etc/kubernetes/ssl/ca.pem \</div><div class="line">  --cert-file=/etc/kubernetes/ssl/kubernetes.pem \</div><div class="line">  --key-file=/etc/kubernetes/ssl/kubernetes-key.pem \</div><div class="line">  mk /kube-centos/network/config '&#123;"Network":"172.30.0.0/16","SubnetLen":24,"Backend":&#123;"Type":"vxlan"&#125;&#125;'</div></pre></td></tr></table></figure>
<h4 id="配置Docker"><a href="#配置Docker" class="headerlink" title="配置Docker"></a>配置Docker</h4><p>如果你不是使用yum安装的flanneld, 需要执行下载文件解压出的<strong>mk-docker-opts.sh</strong>文件.</p>
<p>这个文件是用来<code>Generate Docker daemon options based on flannel env file</code>.</p>
<p>执行<code>./mk-docker-opts.sh -i</code>将会生成如下两个文件环境变量文件</p>
<p>重启docker</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">service docker stop</div><div class="line">dockerd --bip=$&#123;FLANNEL_SUBNET&#125; --mtu=$&#123;FLANNEL_MTU&#125;</div><div class="line"><span class="meta">#</span><span class="bash"> 设置docker0网桥的IP地址</span></div><div class="line">ifconfig docker0 $FLANNEL_SUBNET</div><div class="line"><span class="meta">#</span><span class="bash"> 环境变量配置</span></div><div class="line">cat &gt; /etc/systemd/system/docker.service.d/flannel.conf &lt;&lt;EOF</div><div class="line">[Service]</div><div class="line">EnvironmentFile=-/run/flannel/docker</div><div class="line">EnvironmentFile=-/run/docker_opts.env</div><div class="line">EnvironmentFile=-/run/flannel/subnet.env</div><div class="line">EOF</div></pre></td></tr></table></figure>
<h3 id="安装和配置-kubelet"><a href="#安装和配置-kubelet" class="headerlink" title="安装和配置 kubelet"></a>安装和配置 kubelet</h3><h4 id="下载最新的-kubelet-和-kube-proxy-二进制文件"><a href="#下载最新的-kubelet-和-kube-proxy-二进制文件" class="headerlink" title="下载最新的 kubelet 和 kube-proxy 二进制文件"></a>下载最新的 kubelet 和 kube-proxy 二进制文件</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">wget https://dl.k8s.io/v1.8.4/kubernetes-server-linux-amd64.tar.gz</div><div class="line">tar -xzvf kubernetes-server-linux-amd64.tar.gz</div><div class="line">cd kubernetes</div><div class="line">tar -xzvf  kubernetes-src.tar.gz</div><div class="line">cp -r ./server/bin/&#123;kube-proxy,kubelet&#125; /usr/local/bin/</div></pre></td></tr></table></figure>
<h4 id="创建-kubelet-的service配置文件"><a href="#创建-kubelet-的service配置文件" class="headerlink" title="创建 kubelet 的service配置文件"></a>创建 kubelet 的service配置文件</h4><p><code>/etc/systemd/system/kubelet.service</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">[Unit]</div><div class="line">Description=Kubernetes Kubelet Server</div><div class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</div><div class="line">After=docker.service</div><div class="line">Requires=docker.service</div><div class="line"></div><div class="line">[Service]</div><div class="line">WorkingDirectory=/var/lib/kubelet</div><div class="line">EnvironmentFile=-/etc/kubernetes/config</div><div class="line">EnvironmentFile=-/etc/kubernetes/kubelet</div><div class="line">ExecStart=/usr/local/bin/kubelet \</div><div class="line">            $KUBE_LOGTOSTDERR \</div><div class="line">            $KUBE_LOG_LEVEL \</div><div class="line">            $KUBELET_API_SERVER \</div><div class="line">            $KUBELET_ADDRESS \</div><div class="line">            $KUBELET_PORT \</div><div class="line">            $KUBELET_HOSTNAME \</div><div class="line">            $KUBE_ALLOW_PRIV \</div><div class="line">            $KUBELET_POD_INFRA_CONTAINER \</div><div class="line">            $KUBELET_ARGS</div><div class="line">Restart=on-failure</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div></pre></td></tr></table></figure>
<p>kubelet的配置文件<code>/etc/kubernetes/kubelet</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">cat &gt; /etc/kubernetes/kubelet &lt;&lt;EOF</div><div class="line"><span class="meta">#</span><span class="bash"><span class="comment">##</span></span></div><div class="line"><span class="meta">#</span><span class="bash"><span class="comment"># kubernetes kubelet (minion) config</span></span></div><div class="line"><span class="meta">#</span><span class="bash"></span></div><div class="line"><span class="meta">#</span><span class="bash"><span class="comment"># The address for the info server to serve on (set to 0.0.0.0 or "" for all interfaces)</span></span></div><div class="line">KUBELET_ADDRESS="--address=192.168.10.58"</div><div class="line"><span class="meta">#</span><span class="bash"></span></div><div class="line"><span class="meta">#</span><span class="bash"><span class="comment"># The port for the info server to serve on</span></span></div><div class="line"><span class="meta">#</span><span class="bash">KUBELET_PORT=<span class="string">"--port=10250"</span></span></div><div class="line"><span class="meta">#</span><span class="bash"></span></div><div class="line"><span class="meta">#</span><span class="bash"><span class="comment"># You may leave this blank to use the actual hostname</span></span></div><div class="line">KUBELET_HOSTNAME="--hostname-override=192.168.10.58"</div><div class="line"><span class="meta">#</span><span class="bash"></span></div><div class="line"><span class="meta">#</span><span class="bash"><span class="comment"># location of the api-server已过时</span></span></div><div class="line"><span class="meta">#</span><span class="bash"> KUBELET_API_SERVER=<span class="string">"--api-servers=http://192.168.10.58:8080"</span></span></div><div class="line"><span class="meta">#</span><span class="bash"></span></div><div class="line"><span class="meta">#</span><span class="bash"><span class="comment"># pod infrastructure container</span></span></div><div class="line">KUBELET_POD_INFRA_CONTAINER="--pod-infra-container-image=registry.access.redhat.com/rhel7/pod-infrastructure:latest"</div><div class="line"><span class="meta">#</span><span class="bash"></span></div><div class="line"><span class="meta">#</span><span class="bash"><span class="comment"># Add your own!</span></span></div><div class="line"><span class="meta">#</span><span class="bash"> --cgroup-driver=systemd 的配置需要跟docker一样</span></div><div class="line">KUBELET_ARGS="--cgroup-driver=cgroupfs --cluster-dns=10.254.0.2 --experimental-bootstrap-kubeconfig=/etc/kubernetes/bootstrap.kubeconfig --kubeconfig=/etc/kubernetes/kubelet.kubeconfig --require-kubeconfig --cert-dir=/etc/kubernetes/ssl --cluster-domain=cluster.local --hairpin-mode promiscuous-bridge --serialize-image-pulls=false"</div><div class="line">EOF</div></pre></td></tr></table></figure>
<blockquote>
<p>handbook上说, /etc/kubernetes/kubelet.kubeconfig可暂时不创建, 在之后的步骤中会自动创建, 我是直接<code>cp ~/.kube/config /etc/kubernetes/kulelet.kubeconfg</code>, config文件是否可以不存在, 之后需要再验证</p>
</blockquote>
<h4 id="启动kubelet"><a href="#启动kubelet" class="headerlink" title="启动kubelet"></a>启动kubelet</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">systemctl daemon-reload</div><div class="line">systemctl enable kubelet</div><div class="line">systemctl start kubelet</div><div class="line">systemctl status kubelet</div></pre></td></tr></table></figure>
<h3 id="配置-kube-proxy"><a href="#配置-kube-proxy" class="headerlink" title="配置 kube-proxy"></a>配置 kube-proxy</h3><h4 id="创建-kube-proxy-的service配置文件"><a href="#创建-kube-proxy-的service配置文件" class="headerlink" title="创建 kube-proxy 的service配置文件"></a>创建 kube-proxy 的service配置文件</h4><p><code>/etc/systemd/system/kube-proxy.service</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">[Unit]</div><div class="line">Description=Kubernetes Kube-Proxy Server</div><div class="line">Documentation=https://github.com/GoogleCloudPlatform/kubernetes</div><div class="line">After=network.target</div><div class="line"></div><div class="line">[Service]</div><div class="line">EnvironmentFile=-/etc/kubernetes/config</div><div class="line">EnvironmentFile=-/etc/kubernetes/proxy</div><div class="line">ExecStart=/usr/local/bin/kube-proxy \</div><div class="line">        $KUBE_LOGTOSTDERR \</div><div class="line">        $KUBE_LOG_LEVEL \</div><div class="line">        $KUBE_MASTER \</div><div class="line">        $KUBE_PROXY_ARGS</div><div class="line">Restart=on-failure</div><div class="line">LimitNOFILE=65536</div><div class="line"></div><div class="line">[Install]</div><div class="line">WantedBy=multi-user.target</div></pre></td></tr></table></figure>
<p>kube-proxy配置文件<code>/etc/kubernetes/proxy</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">cat &gt; /etc/kubernetes/proxy &lt;&lt;EOF</div><div class="line"><span class="meta">#</span><span class="bash"><span class="comment">##</span></span></div><div class="line"><span class="meta">#</span><span class="bash"> kubernetes proxy config</span></div><div class="line"></div><div class="line"><span class="meta">#</span><span class="bash"> default config should be adequate</span></div><div class="line"></div><div class="line"><span class="meta">#</span><span class="bash"> Add your own!</span></div><div class="line">KUBE_PROXY_ARGS="--bind-address=192.168.10.57 --hostname-override=192.168.10.57 --kubeconfig=/etc/kubernetes/kube-proxy.kubeconfig --cluster-cidr=10.254.0.0/16"</div><div class="line">EOF</div></pre></td></tr></table></figure>
<blockquote>
<p><code>--hostname-override</code> 参数值必须与 kubelet 的值一致，否则 kube-proxy 启动后会找不到该 Node，从而不会创建任何 iptables 规则</p>
</blockquote>
<h4 id="启动kube-proxy"><a href="#启动kube-proxy" class="headerlink" title="启动kube-proxy"></a>启动kube-proxy</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">systemctl daemon-reload</div><div class="line">systemctl enable kube-proxy</div><div class="line">systemctl start kube-proxy</div><div class="line">systemctl status kube-proxy</div></pre></td></tr></table></figure>
<h2 id="安装dashboard"><a href="#安装dashboard" class="headerlink" title="安装dashboard"></a>安装dashboard</h2><p>参考: <a href="https://zhangkesheng.github.io/2017/11/16/Kubernetes-Install/#Kebernetes-Dashboard" target="_blank" rel="external">https://zhangkesheng.github.io/2017/11/16/Kubernetes-Install/#Kebernetes-Dashboard</a></p>
<p><strong> 此方法采用二进制安装, 存在升级问题等一些问题, 下一篇会讲解如何用docker-compose的方式安装 </strong></p>
<p>未完待续…</p>
</div><div class="tags"><a href="/tags/笔记/">笔记</a></div><div class="post-share"></div><div class="post-nav"><a href="/2018/01/25/kubenetes-docker/" class="pre">Kubernetes安装脚本(docker-compose)</a><a href="/2017/11/16/Kubernetes-Install/" class="next">Kubernetes Install</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Kubernetes-HA"><span class="toc-text">Kubernetes HA</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#创建TLS证书和密钥"><span class="toc-text">创建TLS证书和密钥</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#安装CFSSL-源码包安装"><span class="toc-text">安装CFSSL(源码包安装)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建CA"><span class="toc-text">创建CA</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#CA配置文件"><span class="toc-text">CA配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建CA证书签名请求"><span class="toc-text">创建CA证书签名请求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#生成-CA-证书和私钥"><span class="toc-text">生成 CA 证书和私钥</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建kubernetes证书"><span class="toc-text">创建kubernetes证书</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#创建-kubernetes-证书签名请求文件"><span class="toc-text">创建 kubernetes 证书签名请求文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#生成-kubernetes-证书和私钥"><span class="toc-text">生成 kubernetes 证书和私钥</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建admin证书"><span class="toc-text">创建admin证书</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#创建-admin-证书签名请求文件"><span class="toc-text">创建 admin 证书签名请求文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#生成-admin-证书和私钥"><span class="toc-text">生成 admin 证书和私钥</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建-kube-proxy-证书"><span class="toc-text">创建 kube-proxy 证书</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#创建kube-proxy证书签名请求文件"><span class="toc-text">创建kube-proxy证书签名请求文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#生成-kube-proxy-客户端证书和私钥"><span class="toc-text">生成 kube-proxy 客户端证书和私钥</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#校验证书"><span class="toc-text">校验证书</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#opsnssl"><span class="toc-text">opsnssl</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cfssl-certinfo"><span class="toc-text">cfssl-certinfo</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#分发证书"><span class="toc-text">分发证书</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安装kubectl命令行工具"><span class="toc-text">安装kubectl命令行工具</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#下载-kubectl"><span class="toc-text">下载 kubectl</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#创建kubeconfig文件"><span class="toc-text">创建kubeconfig文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#创建TLS-Bootsrapping-Token"><span class="toc-text">创建TLS Bootsrapping Token</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建-kubelet-bootstrapping-kubeconfig-文件"><span class="toc-text">创建 kubelet bootstrapping kubeconfig 文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建-kube-proxy-kubeconfig-文件"><span class="toc-text">创建 kube-proxy kubeconfig 文件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Etcd集群"><span class="toc-text">Etcd集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#下载并安装etcd"><span class="toc-text">下载并安装etcd</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#创建-etcd-的systamd-unit-文件"><span class="toc-text">创建 etcd 的systamd unit 文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动-etcd-服务"><span class="toc-text">启动 etcd 服务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#验证服务"><span class="toc-text">验证服务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#部署master集群"><span class="toc-text">部署master集群</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#部署master节点"><span class="toc-text">部署master节点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#下载最新版二进制文件"><span class="toc-text">下载最新版二进制文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置和启动kube-apiserver"><span class="toc-text">配置和启动kube-apiserver</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#启动kube-apiserver"><span class="toc-text">启动kube-apiserver</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置和启动-kube-controller-manager"><span class="toc-text">配置和启动 kube-controller-manager</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#创建-kube-controller-manager的serivce配置文件"><span class="toc-text">创建 kube-controller-manager的serivce配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#启动-kube-controller-manager"><span class="toc-text">启动 kube-controller-manager</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置和启动-kube-scheduler"><span class="toc-text">配置和启动 kube-scheduler</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#创建-kube-scheduler的serivce配置文件"><span class="toc-text">创建 kube-scheduler的serivce配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#启动-kube-scheduler"><span class="toc-text">启动 kube-scheduler</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#验证-master-节点功能"><span class="toc-text">验证 master 节点功能</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#部署node节点"><span class="toc-text">部署node节点</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#基础配置"><span class="toc-text">基础配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装网络插件Flanneld-可跳过"><span class="toc-text">安装网络插件Flanneld(可跳过)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#在etcd中创建网络配置"><span class="toc-text">在etcd中创建网络配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#配置Docker"><span class="toc-text">配置Docker</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#安装和配置-kubelet"><span class="toc-text">安装和配置 kubelet</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#下载最新的-kubelet-和-kube-proxy-二进制文件"><span class="toc-text">下载最新的 kubelet 和 kube-proxy 二进制文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建-kubelet-的service配置文件"><span class="toc-text">创建 kubelet 的service配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#启动kubelet"><span class="toc-text">启动kubelet</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置-kube-proxy"><span class="toc-text">配置 kube-proxy</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#创建-kube-proxy-的service配置文件"><span class="toc-text">创建 kube-proxy 的service配置文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#启动kube-proxy"><span class="toc-text">启动kube-proxy</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安装dashboard"><span class="toc-text">安装dashboard</span></a></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/06/25/kubernetes-istio-v2/">kubernetes-istio-v2</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/19/Spring Boot Start-up/">Spring Boot 启动速度优化</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/11/phpMyAdmin/">phpMyAdmin</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/16/Let’s Encrypt SSL/">Let's Encrypt 实现站点 SSL</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/12/kubernetes-istio/">kubernetes-istio</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/30/Best Practices for Maintainers/">维护者的最佳实践</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/25/kubenetes-docker/">Kubernetes安装脚本(docker-compose)</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/25/kubernetes-ha/">部署高可用的k8s集群</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/16/Kubernetes-Install/">Kubernetes Install</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/23/hello-world/">Hello World</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Kubernetes/">Kubernetes</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/translate/">translate</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/笔记/">笔记</a><span class="category-list-count">4</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/istio/" style="font-size: 15px;">istio</a> <a href="/tags/spring-boot/" style="font-size: 15px;">spring boot</a> <a href="/tags/SSL/" style="font-size: 15px;">SSL</a> <a href="/tags/HTTPS/" style="font-size: 15px;">HTTPS</a> <a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/无题/" style="font-size: 15px;">无题</a> <a href="/tags/笔记/" style="font-size: 15px;">笔记</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/翻译/" style="font-size: 15px;">翻译</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a></li></ul></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">Baidu Site Haritası</a> |  <a href="/atom.xml">订阅</a> |  <a href="/about/">关于</a></p><p><span> Copyright &copy;<a href="/." rel="nofollow">张克升.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script type="text/javascript" src="/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.1" async></script></body></html>