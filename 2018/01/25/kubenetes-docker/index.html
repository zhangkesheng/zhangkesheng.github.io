<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Kubernetes安装脚本(docker-compose) | 张克升的个人博客</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Kubernetes安装脚本(docker-compose)</h1><a id="logo" href="/.">张克升的个人博客</a><p class="description">不想当架构师的工程师不是好的程序员</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Search"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">Kubernetes安装脚本(docker-compose)</h1><div class="post-meta"><a href="/2018/01/25/kubenetes-docker/#comments" class="comment-count"></a><p><span class="date">Jan 25, 2018</span><span><a href="/categories/Kubernetes/" class="category">Kubernetes</a></span></p></div><div class="post-content"><h1 id="Kubernetes安装脚本"><a href="#Kubernetes安装脚本" class="headerlink" title="Kubernetes安装脚本"></a>Kubernetes安装脚本</h1><h2 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h2><p>节点列表</p>
<p>NODE1：127.0.0.1</p>
<p>NODE2：127.0.0.2</p>
<p>NODE3：127.0.0.3</p>
<h2 id="Docker-daemon-config"><a href="#Docker-daemon-config" class="headerlink" title="Docker daemon config"></a>Docker daemon config</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">cat &gt;/etc/docker/daemon.json &lt;&lt;EOF</div><div class="line">&#123;</div><div class="line">  <span class="string">"registry-mirrors"</span>: [<span class="string">"https://1.mirror.aliyuncs.com"</span>],</div><div class="line">  <span class="string">"log-driver"</span>: <span class="string">"json-file"</span>,</div><div class="line">  <span class="string">"log-opts"</span>: &#123;</div><div class="line">    <span class="string">"max-size"</span>: <span class="string">"10m"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="string">"bridge"</span>: <span class="string">"docker0"</span></div><div class="line">&#125;</div><div class="line">EOF</div></pre></td></tr></table></figure>
<h2 id="Install-cfssl"><a href="#Install-cfssl" class="headerlink" title="Install cfssl"></a>Install cfssl</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Install cfssl utils for generating certs.</span></div><div class="line"><span class="keyword">for</span> bin <span class="keyword">in</span> cfssl cfssljson cfssl-certinfo; <span class="keyword">do</span></div><div class="line">  curl -sSL -o /usr/<span class="built_in">local</span>/bin/<span class="variable">$&#123;bin&#125;</span> https://pkg.cfssl.org/R1.2/<span class="variable">$&#123;bin&#125;</span>_linux-amd64</div><div class="line">  chmod +x /usr/<span class="built_in">local</span>/bin/<span class="variable">$&#123;bin&#125;</span></div><div class="line"><span class="keyword">done</span></div></pre></td></tr></table></figure>
<h2 id="Generate-config"><a href="#Generate-config" class="headerlink" title="Generate config"></a>Generate config</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">cat &gt;ca-config.json &lt;&lt;EOF</div><div class="line">&#123;</div><div class="line">  <span class="string">"signing"</span>: &#123;</div><div class="line">    <span class="string">"default"</span>: &#123;</div><div class="line">        <span class="string">"usages"</span>: [</div><div class="line">          <span class="string">"signing"</span>,</div><div class="line">          <span class="string">"key encipherment"</span>,</div><div class="line">          <span class="string">"server auth"</span>,</div><div class="line">          <span class="string">"client auth"</span></div><div class="line">        ],</div><div class="line">        <span class="string">"expiry"</span>: <span class="string">"876000h"</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">EOF</div></pre></td></tr></table></figure>
<h2 id="Set-Env"><a href="#Set-Env" class="headerlink" title="Set Env"></a>Set Env</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">export</span> NODE1=<span class="string">"127.0.0.1"</span></div><div class="line"><span class="built_in">export</span> NODE2=<span class="string">"127.0.0.2"</span></div><div class="line"><span class="built_in">export</span> NODE3=<span class="string">"127.0.0.3"</span></div><div class="line"><span class="built_in">export</span> MASTER_IPS=<span class="string">"<span class="variable">$&#123;NODE1&#125;</span>,<span class="variable">$&#123;NODE2&#125;</span>,<span class="variable">$&#123;NODE3&#125;</span>"</span></div><div class="line"><span class="built_in">export</span> ETCD_INITIAL_CLUSTER=<span class="string">"etcd-01=https://<span class="variable">$&#123;NODE1&#125;</span>:2380,etcd-02=https://<span class="variable">$&#123;NODE2&#125;</span>:2380,etcd-03=https://<span class="variable">$&#123;NODE3&#125;</span>:2380"</span></div><div class="line"><span class="built_in">export</span> ETCD_SERVERS=<span class="string">"https://<span class="variable">$&#123;NODE1&#125;</span>:2379,https://<span class="variable">$&#123;NODE2&#125;</span>:2379,https://<span class="variable">$&#123;NODE3&#125;</span>:2379"</span></div><div class="line"><span class="built_in">export</span> ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">'myzd-prod-etcd-cluster-token'</span></div><div class="line"><span class="built_in">export</span> KUBE_API_IP=<span class="variable">$&#123;NODE1&#125;</span></div><div class="line"><span class="built_in">export</span> KUBE_API_CLUSTER_IP=<span class="string">"172.16.0.1"</span></div><div class="line"><span class="built_in">export</span> CLUSTER_CIDR=<span class="string">"172.16.64.0/18"</span></div><div class="line"><span class="built_in">export</span> SERVICE_CLUSTER_CIDR=<span class="string">"172.16.0.0/18"</span></div><div class="line"><span class="built_in">export</span> CLUSTER_DNS=<span class="string">"172.16.0.3"</span></div><div class="line"><span class="built_in">export</span> KUBE_API_HA_IP=<span class="string">"127.0.0.4"</span></div><div class="line"><span class="built_in">export</span> KUBE_API_HA_HOST=<span class="string">"https://<span class="variable">$&#123;KUBE_API_HA_IP&#125;</span>"</span></div><div class="line"><span class="comment">## set eviction_head</span></div><div class="line"><span class="built_in">export</span> EVICTION_HARD=<span class="string">"memory.available&lt;10%,nodefs.available&lt;10%"</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">export</span> CURRENT_NODE=<span class="variable">$&#123;NODE1&#125;</span></div><div class="line"><span class="built_in">export</span> ETCD_NAME=<span class="string">"etcd-01"</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">export</span> CURRENT_NODE=<span class="variable">$&#123;NODE2&#125;</span></div><div class="line"><span class="built_in">export</span> ETCD_NAME=<span class="string">"etcd-02"</span></div></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">export</span> CURRENT_NODE=<span class="variable">$&#123;NODE3&#125;</span></div><div class="line"><span class="built_in">export</span> ETCD_NAME=<span class="string">"etcd-03"</span></div></pre></td></tr></table></figure>
<h2 id="Generate-etcd-certificates"><a href="#Generate-etcd-certificates" class="headerlink" title="Generate etcd certificates"></a>Generate etcd certificates</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Generate CA certs for etcd</span></div><div class="line">cat &gt;etcd-cs-ca-csr.json &lt;&lt;EOF</div><div class="line">&#123;</div><div class="line">    <span class="string">"CN"</span>: <span class="string">"MYZD etcd CS CA"</span>,</div><div class="line">    <span class="string">"key"</span>: &#123;</div><div class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</div><div class="line">        <span class="string">"size"</span>: 2048</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"names"</span>: [</div><div class="line">        &#123;</div><div class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>,</div><div class="line">            <span class="string">"ST"</span>: <span class="string">"Shanghai"</span>,</div><div class="line">            <span class="string">"L"</span>: <span class="string">"Shanghai"</span>,</div><div class="line">            <span class="string">"O"</span>: <span class="string">"MYZD"</span>,</div><div class="line">            <span class="string">"OU"</span>: <span class="string">"System"</span></div><div class="line">        &#125;</div><div class="line">    ],</div><div class="line">    <span class="string">"CA"</span>: &#123; <span class="string">"Expiry"</span>: <span class="string">"876000h"</span> &#125;</div><div class="line">&#125;</div><div class="line">EOF</div><div class="line">cfssl gencert -initca etcd-cs-ca-csr.json | cfssljson -bare etcd-cs-ca</div><div class="line"></div><div class="line">cat &gt;etcd-peer-ca-csr.json &lt;&lt;EOF</div><div class="line">&#123;</div><div class="line">    <span class="string">"CN"</span>: <span class="string">"MYZD etcd peer CA"</span>,</div><div class="line">    <span class="string">"key"</span>: &#123;</div><div class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</div><div class="line">        <span class="string">"size"</span>: 2048</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"names"</span>: [</div><div class="line">        &#123;</div><div class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>,</div><div class="line">            <span class="string">"ST"</span>: <span class="string">"Shanghai"</span>,</div><div class="line">            <span class="string">"L"</span>: <span class="string">"Shanghai"</span>,</div><div class="line">            <span class="string">"O"</span>: <span class="string">"MYZD"</span>,</div><div class="line">            <span class="string">"OU"</span>: <span class="string">"System"</span></div><div class="line">        &#125;</div><div class="line">    ],</div><div class="line">    <span class="string">"CA"</span>: &#123; <span class="string">"Expiry"</span>: <span class="string">"876000h"</span> &#125;</div><div class="line">&#125;</div><div class="line">EOF</div><div class="line">cfssl gencert -initca etcd-peer-ca-csr.json | cfssljson -bare etcd-peer-ca</div><div class="line"></div><div class="line"><span class="comment"># Generate peer certificate</span></div><div class="line"><span class="built_in">echo</span> <span class="string">'&#123;"CN":"etcd-peer","hosts":[""],"key":&#123;"algo":"rsa","size":2048&#125;&#125;'</span> |\</div><div class="line">cfssl gencert -ca=etcd-peer-ca.pem -ca-key=etcd-peer-ca-key.pem -config=ca-config.json \</div><div class="line">-hostname=<span class="string">"<span class="variable">$&#123;MASTER_IPS&#125;</span>,etcd-01,etcd-02,etcd-03"</span> - |\</div><div class="line">cfssljson -bare etcd-peer</div><div class="line"></div><div class="line"><span class="comment"># Generate server certificate</span></div><div class="line"><span class="built_in">echo</span> <span class="string">'&#123;"CN":"etcd-server","hosts":[""],"key":&#123;"algo":"rsa","size":2048&#125;&#125;'</span> |\</div><div class="line">cfssl gencert -ca=etcd-cs-ca.pem -ca-key=etcd-cs-ca-key.pem -config=ca-config.json \</div><div class="line">-hostname=<span class="string">"<span class="variable">$&#123;MASTER_IPS&#125;</span>,127.0.0.1,localhost,etcd-01,etcd-02,etcd-03"</span> - |\</div><div class="line">cfssljson -bare etcd-server</div><div class="line"></div><div class="line"><span class="comment"># Generate client certificates</span></div><div class="line"><span class="built_in">echo</span> <span class="string">'&#123;"CN":"etcd-client","hosts":[""],"key":&#123;"algo":"rsa","size":2048&#125;&#125;'</span> |\</div><div class="line">cfssl gencert -ca=etcd-cs-ca.pem -ca-key=etcd-cs-ca-key.pem -config=ca-config.json - |\</div><div class="line">cfssljson -bare etcd-client</div><div class="line"></div><div class="line"><span class="comment"># Copy certs tp etcd config directory(/etc/etcd on each peer)</span></div><div class="line">mkdir etcd</div><div class="line">cp etcd-cs-ca.pem etcd</div><div class="line">cp etcd-peer-ca.pem etcd</div><div class="line">cp etcd-peer.pem etcd</div><div class="line">cp etcd-peer-key.pem etcd</div><div class="line">cp etcd-server.pem etcd</div><div class="line">cp etcd-server-key.pem etcd</div><div class="line">cp etcd-client.pem etcd</div><div class="line">cp etcd-client-key.pem etcd</div></pre></td></tr></table></figure>
<h1 id="Generate-kubernete-certificates"><a href="#Generate-kubernete-certificates" class="headerlink" title="Generate kubernete certificates"></a>Generate kubernete certificates</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Generate CA certs for kebelet</span></div><div class="line">cat &gt;kubelet-ca-csr.json &lt;&lt;EOF</div><div class="line">&#123;</div><div class="line">    <span class="string">"CN"</span>: <span class="string">"MYZD kubelet CA"</span>,</div><div class="line">    <span class="string">"key"</span>: &#123;</div><div class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</div><div class="line">        <span class="string">"size"</span>: 2048</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"names"</span>: [</div><div class="line">        &#123;</div><div class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>,</div><div class="line">            <span class="string">"ST"</span>: <span class="string">"Shanghai"</span>,</div><div class="line">            <span class="string">"L"</span>: <span class="string">"Shanghai"</span>,</div><div class="line">            <span class="string">"O"</span>: <span class="string">"MYZD"</span>,</div><div class="line">            <span class="string">"OU"</span>: <span class="string">"Kubernetes"</span></div><div class="line">        &#125;</div><div class="line">    ],</div><div class="line">    <span class="string">"CA"</span>: &#123; <span class="string">"Expiry"</span>: <span class="string">"876000h"</span> &#125;</div><div class="line">&#125;</div><div class="line">EOF</div><div class="line">cfssl gencert -initca kubelet-ca-csr.json | cfssljson -bare kubelet-ca</div><div class="line"></div><div class="line"><span class="comment"># Generate kubelet-client rsa key pair</span></div><div class="line">cat &gt;kubelet-client-csr.json &lt;&lt;EOF</div><div class="line">&#123;</div><div class="line">  <span class="string">"CN"</span>: <span class="string">"kubelet-client"</span>,</div><div class="line">  <span class="string">"hosts"</span>: [],</div><div class="line">  <span class="string">"key"</span>: &#123;</div><div class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</div><div class="line">    <span class="string">"size"</span>: 2048</div><div class="line">  &#125;,</div><div class="line">  <span class="string">"names"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</div><div class="line">      <span class="string">"ST"</span>: <span class="string">"Shanghai"</span>,</div><div class="line">      <span class="string">"L"</span>: <span class="string">"Shanghai"</span>,</div><div class="line">      <span class="string">"O"</span>: <span class="string">"system:kebulet"</span>,</div><div class="line">      <span class="string">"OU"</span>: <span class="string">"Kubernetes"</span></div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div><div class="line">EOF</div><div class="line">cfssl gencert -ca=kubelet-ca.pem -ca-key=kubelet-ca-key.pem -config=ca-config.json kubelet-client-csr.json | cfssljson -bare kubelet-client-certificate</div><div class="line"></div><div class="line"><span class="comment"># Generate CA certs for kubernetes</span></div><div class="line">cat &gt;kubernetes-ca-csr.json &lt;&lt;EOF</div><div class="line">&#123;</div><div class="line">    <span class="string">"CN"</span>: <span class="string">"MYZD Kubernetes CA"</span>,</div><div class="line">    <span class="string">"key"</span>: &#123;</div><div class="line">        <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</div><div class="line">        <span class="string">"size"</span>: 2048</div><div class="line">    &#125;,</div><div class="line">    <span class="string">"names"</span>: [</div><div class="line">        &#123;</div><div class="line">            <span class="string">"C"</span>: <span class="string">"CN"</span>,</div><div class="line">            <span class="string">"ST"</span>: <span class="string">"Shanghai"</span>,</div><div class="line">            <span class="string">"L"</span>: <span class="string">"Shanghai"</span>,</div><div class="line">            <span class="string">"O"</span>: <span class="string">"MYZD"</span>,</div><div class="line">            <span class="string">"OU"</span>: <span class="string">"System"</span></div><div class="line">        &#125;</div><div class="line">    ],</div><div class="line">    <span class="string">"CA"</span>: &#123; <span class="string">"Expiry"</span>: <span class="string">"876000h"</span> &#125;</div><div class="line">&#125;</div><div class="line">EOF</div><div class="line">cfssl gencert -initca kubernetes-ca-csr.json | cfssljson -bare kube-ca</div><div class="line"><span class="comment"># Generate service account rsa key pair</span></div><div class="line">openssl genrsa -out kube-service-account.key 4096</div><div class="line"></div><div class="line">cat &gt;kube-admin-csr.json &lt;&lt;EOF</div><div class="line">&#123;</div><div class="line">  <span class="string">"CN"</span>: <span class="string">"admin"</span>,</div><div class="line">  <span class="string">"hosts"</span>: [],</div><div class="line">  <span class="string">"key"</span>: &#123;</div><div class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</div><div class="line">    <span class="string">"size"</span>: 2048</div><div class="line">  &#125;,</div><div class="line">  <span class="string">"names"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</div><div class="line">      <span class="string">"ST"</span>: <span class="string">"Shanghai"</span>,</div><div class="line">      <span class="string">"L"</span>: <span class="string">"Shanghai"</span>,</div><div class="line">      <span class="string">"O"</span>: <span class="string">"system:masters"</span>,</div><div class="line">      <span class="string">"OU"</span>: <span class="string">"Kubernetes"</span></div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div><div class="line">EOF</div><div class="line">cfssl gencert -ca=kube-ca.pem -ca-key=kube-ca-key.pem -config=ca-config.json \</div><div class="line">kube-admin-csr.json | cfssljson -bare kube-admin</div><div class="line"></div><div class="line">cat &gt;kube-controller-csr.json &lt;&lt;EOF</div><div class="line">&#123;</div><div class="line">  <span class="string">"CN"</span>: <span class="string">"system:kube-controller-manager"</span>,</div><div class="line">  <span class="string">"hosts"</span>: [],</div><div class="line">  <span class="string">"key"</span>: &#123;</div><div class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</div><div class="line">    <span class="string">"size"</span>: 2048</div><div class="line">  &#125;,</div><div class="line">  <span class="string">"names"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</div><div class="line">      <span class="string">"ST"</span>: <span class="string">"Shanghai"</span>,</div><div class="line">      <span class="string">"L"</span>: <span class="string">"Shanghai"</span>,</div><div class="line">      <span class="string">"O"</span>: <span class="string">"system"</span>,</div><div class="line">      <span class="string">"OU"</span>: <span class="string">"Kubernetes"</span></div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div><div class="line">EOF</div><div class="line">cfssl gencert -ca=kube-ca.pem -ca-key=kube-ca-key.pem -config=ca-config.json \</div><div class="line">kube-controller-csr.json | cfssljson -bare kube-controller</div><div class="line"></div><div class="line">cat &gt;kube-scheduler-csr.json &lt;&lt;EOF</div><div class="line">&#123;</div><div class="line">  <span class="string">"CN"</span>: <span class="string">"system:kube-scheduler"</span>,</div><div class="line">  <span class="string">"hosts"</span>: [],</div><div class="line">  <span class="string">"key"</span>: &#123;</div><div class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</div><div class="line">    <span class="string">"size"</span>: 2048</div><div class="line">  &#125;,</div><div class="line">  <span class="string">"names"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</div><div class="line">      <span class="string">"ST"</span>: <span class="string">"Shanghai"</span>,</div><div class="line">      <span class="string">"L"</span>: <span class="string">"Shanghai"</span>,</div><div class="line">      <span class="string">"O"</span>: <span class="string">"system"</span>,</div><div class="line">      <span class="string">"OU"</span>: <span class="string">"Kubernetes"</span></div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div><div class="line">EOF</div><div class="line">cfssl gencert -ca=kube-ca.pem -ca-key=kube-ca-key.pem -config=ca-config.json \</div><div class="line">kube-scheduler-csr.json | cfssljson -bare kube-scheduler</div><div class="line"></div><div class="line">cat &gt;kube-proxy-csr.json &lt;&lt;EOF</div><div class="line">&#123;</div><div class="line">  <span class="string">"CN"</span>: <span class="string">"system:kube-proxy"</span>,</div><div class="line">  <span class="string">"hosts"</span>: [],</div><div class="line">  <span class="string">"key"</span>: &#123;</div><div class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</div><div class="line">    <span class="string">"size"</span>: 2048</div><div class="line">  &#125;,</div><div class="line">  <span class="string">"names"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</div><div class="line">      <span class="string">"ST"</span>: <span class="string">"Shanghai"</span>,</div><div class="line">      <span class="string">"L"</span>: <span class="string">"Shanghai"</span>,</div><div class="line">      <span class="string">"O"</span>: <span class="string">"system"</span>,</div><div class="line">      <span class="string">"OU"</span>: <span class="string">"Kubernetes"</span></div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div><div class="line">EOF</div><div class="line">cfssl gencert -ca=kube-ca.pem -ca-key=kube-ca-key.pem -config=ca-config.json \</div><div class="line">kube-proxy-csr.json | cfssljson -bare kube-proxy</div><div class="line"></div><div class="line">cat &gt;kubelet-csr.json &lt;&lt;EOF</div><div class="line">&#123;</div><div class="line">  <span class="string">"CN"</span>: <span class="string">"system:kubelet"</span>,</div><div class="line">  <span class="string">"hosts"</span>: [],</div><div class="line">  <span class="string">"key"</span>: &#123;</div><div class="line">    <span class="string">"algo"</span>: <span class="string">"rsa"</span>,</div><div class="line">    <span class="string">"size"</span>: 2048</div><div class="line">  &#125;,</div><div class="line">  <span class="string">"names"</span>: [</div><div class="line">    &#123;</div><div class="line">      <span class="string">"C"</span>: <span class="string">"CN"</span>,</div><div class="line">      <span class="string">"ST"</span>: <span class="string">"Shanghai"</span>,</div><div class="line">      <span class="string">"L"</span>: <span class="string">"Shanghai"</span>,</div><div class="line">      <span class="string">"O"</span>: <span class="string">"system:node"</span>,</div><div class="line">      <span class="string">"OU"</span>: <span class="string">"Kubernetes"</span></div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div><div class="line">EOF</div><div class="line">cfssl gencert -ca=kube-ca.pem -ca-key=kube-ca-key.pem -config=ca-config.json \</div><div class="line">kubelet-csr.json | cfssljson -bare kubelet</div><div class="line"></div><div class="line"><span class="comment"># Generate apiserver https certs</span></div><div class="line"><span class="built_in">echo</span> <span class="string">'&#123;"CN":"kube-api","hosts":[""],"key":&#123;"algo":"rsa","size":2048&#125;&#125;'</span> |\</div><div class="line">cfssl gencert -ca=kube-ca.pem -ca-key=kube-ca-key.pem -config=ca-config.json \</div><div class="line">-hostname=<span class="string">"<span class="variable">$&#123;MASTER_IPS&#125;</span>,127.0.0.1,localhost,kube-api,<span class="variable">$&#123;KUBE_API_CLUSTER_IP&#125;</span>,<span class="variable">$&#123;KUBE_API_HA_IP&#125;</span>"</span> - |\</div><div class="line">cfssljson -bare kube-api</div><div class="line"></div><div class="line"><span class="comment"># Copy certs to kubernetes config directory(/etc/kubernetes on each master)</span></div><div class="line">mkdir kubernetes</div><div class="line">cp kube-ca.pem kubernetes</div><div class="line">cp kubelet.pem kubernetes</div><div class="line">cp kubelet-key.pem kubernetes</div><div class="line">cp kubelet-ca.pem kubernetes</div><div class="line"><span class="comment"># masters only</span></div><div class="line">cp etcd-cs-ca.pem kubernetes</div><div class="line">cp etcd-client.pem kubernetes</div><div class="line">cp etcd-client-key.pem kubernetes</div><div class="line">cp kube-service-account.key kubernetes</div><div class="line">cp kube-api.pem kubernetes</div><div class="line">cp kube-api-key.pem kubernetes</div><div class="line">cp kube-controller.pem kubernetes</div><div class="line">cp kube-controller-key.pem kubernetes</div><div class="line">cp kube-scheduler.pem kubernetes</div><div class="line">cp kube-scheduler-key.pem kubernetes</div><div class="line">cp kube-proxy.pem kubernetes</div><div class="line">cp kube-proxy-key.pem kubernetes</div><div class="line">cp kubelet-client-certificate.pem kubernetes</div><div class="line">cp kubelet-client-certificate-key.pem kubernetes</div><div class="line"></div><div class="line">mkdir bak</div><div class="line">cp *.pem bak</div></pre></td></tr></table></figure>
<h1 id="Generate-kubernete-configurations"><a href="#Generate-kubernete-configurations" class="headerlink" title="Generate kubernete configurations"></a>Generate kubernete configurations</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Generate config for kubernetes components.</span></div><div class="line">cat &gt;kubernetes/kubecfg-controller.yml &lt;&lt;EOF</div><div class="line">apiVersion: v1</div><div class="line">kind: Config</div><div class="line">clusters:</div><div class="line">- cluster:</div><div class="line">    api-version: v1</div><div class="line">    certificate-authority: /etc/kubernetes/kube-ca.pem</div><div class="line">    server: <span class="string">"<span class="variable">$&#123;KUBE_API_HA_HOST&#125;</span>"</span></div><div class="line">  name: <span class="string">"local"</span></div><div class="line">contexts:</div><div class="line">- context:</div><div class="line">    cluster: <span class="string">"local"</span></div><div class="line">    user: <span class="string">"kube-controller"</span></div><div class="line">  name: <span class="string">"Default"</span></div><div class="line">current-context: <span class="string">"Default"</span></div><div class="line">users:</div><div class="line">- name: <span class="string">"kube-controller"</span></div><div class="line">  user:</div><div class="line">    client-certificate: /etc/kubernetes/kube-controller.pem</div><div class="line">    client-key: /etc/kubernetes/kube-controller-key.pem</div><div class="line">EOF</div><div class="line"></div><div class="line">cat &gt;kubernetes/kubecfg-scheduler.yml &lt;&lt;EOF</div><div class="line">apiVersion: v1</div><div class="line">kind: Config</div><div class="line">clusters:</div><div class="line">- cluster:</div><div class="line">    api-version: v1</div><div class="line">    certificate-authority: /etc/kubernetes/kube-ca.pem</div><div class="line">    server: <span class="string">"<span class="variable">$&#123;KUBE_API_HA_HOST&#125;</span>"</span></div><div class="line">  name: <span class="string">"local"</span></div><div class="line">contexts:</div><div class="line">- context:</div><div class="line">    cluster: <span class="string">"local"</span></div><div class="line">    user: <span class="string">"kube-scheduler"</span></div><div class="line">  name: <span class="string">"Default"</span></div><div class="line">current-context: <span class="string">"Default"</span></div><div class="line">users:</div><div class="line">- name: <span class="string">"kube-scheduler"</span></div><div class="line">  user:</div><div class="line">    client-certificate: /etc/kubernetes/kube-scheduler.pem</div><div class="line">    client-key: /etc/kubernetes/kube-scheduler-key.pem</div><div class="line">EOF</div><div class="line"></div><div class="line">cat &gt;kubernetes/kubecfg-proxy.yml &lt;&lt;EOF</div><div class="line">apiVersion: v1</div><div class="line">kind: Config</div><div class="line">clusters:</div><div class="line">- cluster:</div><div class="line">    api-version: v1</div><div class="line">    certificate-authority: /etc/kubernetes/kube-ca.pem</div><div class="line">    server: <span class="string">"<span class="variable">$&#123;KUBE_API_HA_HOST&#125;</span>"</span></div><div class="line">  name: <span class="string">"local"</span></div><div class="line">contexts:</div><div class="line">- context:</div><div class="line">    cluster: <span class="string">"local"</span></div><div class="line">    user: <span class="string">"kube-proxy"</span></div><div class="line">  name: <span class="string">"Default"</span></div><div class="line">current-context: <span class="string">"Default"</span></div><div class="line">users:</div><div class="line">- name: <span class="string">"kube-proxy"</span></div><div class="line">  user:</div><div class="line">    client-certificate: /etc/kubernetes/kube-proxy.pem</div><div class="line">    client-key: /etc/kubernetes/kube-proxy-key.pem</div><div class="line">EOF</div><div class="line"></div><div class="line">cat &gt;kubernetes/kubecfg-kubelet.yml &lt;&lt;EOF</div><div class="line">apiVersion: v1</div><div class="line">kind: Config</div><div class="line">clusters:</div><div class="line">- cluster:</div><div class="line">    api-version: v1</div><div class="line">    certificate-authority: /etc/kubernetes/kube-ca.pem</div><div class="line">    server: <span class="string">"<span class="variable">$&#123;KUBE_API_HA_HOST&#125;</span>"</span></div><div class="line">  name: <span class="string">"local"</span></div><div class="line">contexts:</div><div class="line">- context:</div><div class="line">    cluster: <span class="string">"local"</span></div><div class="line">    user: <span class="string">"kubelet"</span></div><div class="line">  name: <span class="string">"Default"</span></div><div class="line">current-context: <span class="string">"Default"</span></div><div class="line">users:</div><div class="line">- name: <span class="string">"kubelet"</span></div><div class="line">  user:</div><div class="line">    client-certificate: /etc/kubernetes/kubelet.pem</div><div class="line">    client-key: /etc/kubernetes/kubelet-key.pem</div><div class="line">EOF</div></pre></td></tr></table></figure>
<h2 id="Run-basic-services-on-each-node"><a href="#Run-basic-services-on-each-node" class="headerlink" title="Run basic services on each node"></a>Run basic services on each node</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># daemons with docker-compose files</span></div><div class="line">mkdir daemons</div><div class="line"></div><div class="line">cat &gt;daemons/etcd.yml &lt;&lt;EOF</div><div class="line">version: <span class="string">'2'</span></div><div class="line">services:</div><div class="line">  etcd:</div><div class="line">    image: bestmike007/etcd:v3.2.13</div><div class="line">    container_name: etcd</div><div class="line">    restart: always</div><div class="line">    network_mode: host</div><div class="line">    volumes:</div><div class="line">    - /srv/etcd:/<span class="variable">$&#123;ETCD_NAME&#125;</span>.etcd</div><div class="line">    - /etc/etcd:/certs:ro</div><div class="line">    environment:</div><div class="line">      ETCD_NAME: <span class="variable">$&#123;ETCD_NAME&#125;</span></div><div class="line">      ETCD_INITIAL_ADVERTISE_PEER_URLS: https://<span class="variable">$&#123;CURRENT_NODE&#125;</span>:2380</div><div class="line">      ETCD_LISTEN_PEER_URLS: https://<span class="variable">$&#123;CURRENT_NODE&#125;</span>:2380</div><div class="line">      ETCD_ADVERTISE_CLIENT_URLS: https://<span class="variable">$&#123;CURRENT_NODE&#125;</span>:2379</div><div class="line">      ETCD_LISTEN_CLIENT_URLS: https://<span class="variable">$&#123;CURRENT_NODE&#125;</span>:2379,https://127.0.0.1:2379</div><div class="line">      ETCD_INITIAL_CLUSTER_TOKEN: <span class="variable">$&#123;ETCD_INITIAL_CLUSTER_TOKEN&#125;</span></div><div class="line">      ETCD_INITIAL_CLUSTER: <span class="variable">$&#123;ETCD_INITIAL_CLUSTER&#125;</span></div><div class="line">      ETCD_CLIENT_CERT_AUTH: <span class="string">"true"</span></div><div class="line">      ETCD_TRUSTED_CA_FILE: /certs/etcd-cs-ca.pem</div><div class="line">      ETCD_CERT_FILE: /certs/etcd-server.pem</div><div class="line">      ETCD_KEY_FILE: /certs/etcd-server-key.pem</div><div class="line">      ETCD_PEER_CLIENT_CERT_AUTH: <span class="string">"true"</span></div><div class="line">      ETCD_PEER_TRUSTED_CA_FILE: /certs/etcd-peer-ca.pem</div><div class="line">      ETCD_PEER_CERT_FILE: /certs/etcd-peer.pem</div><div class="line">      ETCD_PEER_KEY_FILE: /certs/etcd-peer-key.pem</div><div class="line">EOF</div><div class="line"></div><div class="line">cat &gt;daemons/kube-master.yml &lt;&lt;EOF</div><div class="line">version: <span class="string">'2'</span></div><div class="line">services:</div><div class="line">  kube-api:</div><div class="line">    image: bestmike007/hyperkube:v1.9.1</div><div class="line">    container_name: kube-api</div><div class="line">    restart: always</div><div class="line">    network_mode: host</div><div class="line">    volumes:</div><div class="line">    - /etc/kubernetes:/etc/kubernetes:ro</div><div class="line">    <span class="built_in">command</span>: <span class="string">"/usr/local/bin/kube-apiserver \</span></div><div class="line"><span class="string">              --apiserver-count=3 \</span></div><div class="line"><span class="string">              --allow_privileged=true \</span></div><div class="line"><span class="string">              --service-cluster-ip-range=<span class="variable">$&#123;SERVICE_CLUSTER_CIDR&#125;</span> \</span></div><div class="line"><span class="string">              --kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname \</span></div><div class="line"><span class="string">              --admission-control=ServiceAccount,NamespaceLifecycle,LimitRanger,PersistentVolumeLabel,DefaultStorageClass,ResourceQuota,DefaultTolerationSeconds \</span></div><div class="line"><span class="string">              --runtime-config=batch/v2alpha1 \</span></div><div class="line"><span class="string">              --runtime-config=authentication.k8s.io/v1beta1=true \</span></div><div class="line"><span class="string">              --runtime-config=extensions/v1beta1/podsecuritypolicy=true \</span></div><div class="line"><span class="string">              --storage-backend=etcd3 \</span></div><div class="line"><span class="string">              --etcd-servers=<span class="variable">$&#123;ETCD_SERVERS&#125;</span> \</span></div><div class="line"><span class="string">              --etcd-cafile=/etc/kubernetes/etcd-cs-ca.pem \</span></div><div class="line"><span class="string">              --etcd-certfile=/etc/kubernetes/etcd-client.pem \</span></div><div class="line"><span class="string">              --etcd-keyfile=/etc/kubernetes/etcd-client-key.pem \</span></div><div class="line"><span class="string">              --client-ca-file=/etc/kubernetes/kube-ca.pem \</span></div><div class="line"><span class="string">              --service-account-key-file=/etc/kubernetes/kube-service-account.key \</span></div><div class="line"><span class="string">              --tls-ca-file=/etc/kubernetes/kube-ca.pem \</span></div><div class="line"><span class="string">              --tls-cert-file=/etc/kubernetes/kube-api.pem \</span></div><div class="line"><span class="string">              --tls-private-key-file=/etc/kubernetes/kube-api-key.pem \</span></div><div class="line"><span class="string">              --authorization-mode=RBAC \</span></div><div class="line"><span class="string">              --kubelet-client-certificate=/etc/kubernetes/kubelet-client-certificate.pem \</span></div><div class="line"><span class="string">              --kubelet-client-key=/etc/kubernetes/kubelet-client-certificate-key.pem \</span></div><div class="line"><span class="string">              --v=4"</span></div><div class="line">  kube-controller:</div><div class="line">    image: bestmike007/hyperkube:v1.9.1</div><div class="line">    container_name: kube-controller</div><div class="line">    restart: always</div><div class="line">    network_mode: host</div><div class="line">    volumes:</div><div class="line">    - /etc/kubernetes:/etc/kubernetes:ro</div><div class="line">    <span class="built_in">command</span>: <span class="string">"/usr/local/bin/kube-controller-manager \</span></div><div class="line"><span class="string">              --address=0.0.0.0 \</span></div><div class="line"><span class="string">              --leader-elect=true \</span></div><div class="line"><span class="string">              --kubeconfig=/etc/kubernetes/kubecfg-controller.yml \</span></div><div class="line"><span class="string">              --enable-hostpath-provisioner=false \</span></div><div class="line"><span class="string">              --node-monitor-grace-period=40s \</span></div><div class="line"><span class="string">              --pod-eviction-timeout=5m0s \</span></div><div class="line"><span class="string">              --v=2 \</span></div><div class="line"><span class="string">              --allocate-node-cidrs=true \</span></div><div class="line"><span class="string">              --cluster-cidr=<span class="variable">$&#123;CLUSTER_CIDR&#125;</span> \</span></div><div class="line"><span class="string">              --service-cluster-ip-range=<span class="variable">$&#123;SERVICE_CLUSTER_CIDR&#125;</span> \</span></div><div class="line"><span class="string">              --service-account-private-key-file=/etc/kubernetes/kube-service-account.key \</span></div><div class="line"><span class="string">              --root-ca-file=/etc/kubernetes/kube-ca.pem \</span></div><div class="line"><span class="string">              --use-service-account-credentials=true"</span></div><div class="line">  kube-scheduler:</div><div class="line">    image: bestmike007/hyperkube:v1.9.1</div><div class="line">    container_name: kube-scheduler</div><div class="line">    restart: always</div><div class="line">    network_mode: host</div><div class="line">    volumes:</div><div class="line">    - /etc/kubernetes:/etc/kubernetes:ro</div><div class="line">    <span class="built_in">command</span>: <span class="string">"/usr/local/bin/kube-scheduler \</span></div><div class="line"><span class="string">              --leader-elect=true \</span></div><div class="line"><span class="string">              --v=2 \</span></div><div class="line"><span class="string">              --kubeconfig=/etc/kubernetes/kubecfg-scheduler.yml \</span></div><div class="line"><span class="string">              --address=0.0.0.0"</span></div><div class="line">EOF</div><div class="line"></div><div class="line">cat &gt;daemons/kube-node.yml &lt;&lt;EOF</div><div class="line">version: <span class="string">'2'</span></div><div class="line">services:</div><div class="line">  kubelet:</div><div class="line">    image: bestmike007/hyperkube:v1.9.1</div><div class="line">    container_name: kubelet</div><div class="line">    restart: always</div><div class="line">    privileged: <span class="literal">true</span></div><div class="line">    pid: host</div><div class="line">    network_mode: host</div><div class="line">    volumes:</div><div class="line">    - /var/<span class="built_in">log</span>:/var/<span class="built_in">log</span></div><div class="line">    - /dev:/dev</div><div class="line">    - /run:/run</div><div class="line">    - /sys:/sys:ro</div><div class="line">    - /sys/fs/cgroup:/sys/fs/cgroup:rw</div><div class="line">    - /var/run:/var/run:rw</div><div class="line">    - /var/lib/docker/:/var/lib/docker:rw</div><div class="line">    - /var/lib/kubelet/:/var/lib/kubelet:shared</div><div class="line">    - /etc/kubernetes:/etc/kubernetes:ro</div><div class="line">    - /etc/cni:/etc/cni:ro</div><div class="line">    - /opt/cni/bin:/opt/cni/<span class="built_in">local</span>/bin:rw</div><div class="line">    <span class="built_in">command</span>: bash -c <span class="string">"cp /opt/cni/bin/* /opt/cni/local/bin &amp;&amp; \</span></div><div class="line"><span class="string">              /usr/local/bin/kubelet \</span></div><div class="line"><span class="string">              --v=2 \</span></div><div class="line"><span class="string">              --address=0.0.0.0 \</span></div><div class="line"><span class="string">              --anonymous-auth=false \</span></div><div class="line"><span class="string">              --client-ca-file=/etc/kubernetes/kubelet-ca.pem \</span></div><div class="line"><span class="string">              --cluster-domain=cluster.local \</span></div><div class="line"><span class="string">              --pod-infra-container-image=bestmike007/pause-amd64:3.1 \</span></div><div class="line"><span class="string">              --cgroups-per-qos=True \</span></div><div class="line"><span class="string">              --enforce-node-allocatable= \</span></div><div class="line"><span class="string">              --hostname-override=<span class="variable">$&#123;CURRENT_NODE&#125;</span> \</span></div><div class="line"><span class="string">              --cluster-dns=<span class="variable">$&#123;CLUSTER_DNS&#125;</span> \</span></div><div class="line"><span class="string">              --network-plugin=cni \</span></div><div class="line"><span class="string">              --cni-conf-dir=/etc/cni/net.d \</span></div><div class="line"><span class="string">              --cni-bin-dir=/opt/cni/local/bin \</span></div><div class="line"><span class="string">              --resolv-conf=/etc/resolv.conf \</span></div><div class="line"><span class="string">              --allow-privileged=true \</span></div><div class="line"><span class="string">              --cloud-provider= \</span></div><div class="line"><span class="string">              --kubeconfig=/etc/kubernetes/kubecfg-kubelet.yml \</span></div><div class="line"><span class="string">              --require-kubeconfig=True \</span></div><div class="line"><span class="string">              --fail-swap-on=false \</span></div><div class="line"><span class="string">              --eviction-hard='<span class="variable">$&#123;EVICTION_HARD&#125;</span>'"</span></div><div class="line">  kube-proxy:</div><div class="line">    image: bestmike007/hyperkube:v1.9.1</div><div class="line">    container_name: kube-proxy</div><div class="line">    restart: always</div><div class="line">    privileged: <span class="literal">true</span></div><div class="line">    network_mode: host</div><div class="line">    volumes:</div><div class="line">    - /etc/kubernetes:/etc/kubernetes:ro</div><div class="line">    <span class="built_in">command</span>: <span class="string">"/usr/local/bin/kube-proxy \</span></div><div class="line"><span class="string">              --healthz-bind-address=0.0.0.0 \</span></div><div class="line"><span class="string">              --kubeconfig=/etc/kubernetes/kubecfg-proxy.yml \</span></div><div class="line"><span class="string">              --v=2"</span></div><div class="line">EOF</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">docker-compose -f ~/daemons/etcd.yml up -d</div><div class="line">docker-compose -f ~/daemons/kube-master.yml up -d</div><div class="line">docker-compose -f ~/daemons/kube-node.yml up -d</div></pre></td></tr></table></figure>
<h2 id="Post-config-cluster"><a href="#Post-config-cluster" class="headerlink" title="Post-config cluster"></a>Post-config cluster</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># check etcd cluster health</span></div><div class="line"><span class="comment"># etcdctl --ca-file=/certs/etcd-cs-ca.pem --endpoints=https://127.0.0.1:2379 --key-file=/certs/etcd-client-key.pem --cert-file=/certs/etcd-client.pem cluster-health</span></div><div class="line"></div><div class="line"><span class="comment"># use the first master, run the following command after `docker exec -it kubelet sh`</span></div><div class="line">kubectl create clusterrolebinding \</div><div class="line">kubelet-node-binding --clusterrole=system:node --user=system:kubelet</div><div class="line"><span class="comment"># set up weave cni network.</span></div><div class="line"><span class="comment"># 注意: 这里的IPALLOC_RANGE与SERVICE_CLUSTER_CIDR相同</span></div><div class="line">kubectl apply -f \</div><div class="line"><span class="string">"https://cloud.weave.works/k8s/net?k8s-version=<span class="variable">$(kubectl version | base64 | tr -d '\n')</span>&amp;env.IPALLOC_RANGE=172.18.64.0/18"</span></div></pre></td></tr></table></figure>
<h2 id="Firewall"><a href="#Firewall" class="headerlink" title="Firewall"></a>Firewall</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># kube-api</span></div><div class="line">ufw allow 6443/tcp</div><div class="line"><span class="comment"># etcd</span></div><div class="line">ufw allow 2379/tcp</div><div class="line">ufw allow 2380/tcp</div><div class="line"><span class="comment"># weave</span></div><div class="line">ufw allow proto any from <span class="variable">$&#123;NODE1&#125;</span> to any port 6783</div><div class="line">ufw allow proto any from <span class="variable">$&#123;NODE2&#125;</span> to any port 6783</div><div class="line">ufw allow proto any from <span class="variable">$&#123;NODE3&#125;</span> to any port 6783</div><div class="line">ufw allow proto udp from <span class="variable">$&#123;NODE1&#125;</span> to any port 6784</div><div class="line">ufw allow proto udp from <span class="variable">$&#123;NODE2&#125;</span> to any port 6784</div><div class="line">ufw allow proto udp from <span class="variable">$&#123;NODE3&#125;</span> to any port 6784</div><div class="line"><span class="comment"># kubelet</span></div><div class="line">ufw allow proto tcp from <span class="variable">$&#123;NODE1&#125;</span> to any port 10250</div><div class="line">ufw allow proto tcp from <span class="variable">$&#123;NODE2&#125;</span> to any port 10250</div><div class="line">ufw allow proto tcp from <span class="variable">$&#123;NODE3&#125;</span> to any port 10250</div></pre></td></tr></table></figure>
<h1 id="Tear-down"><a href="#Tear-down" class="headerlink" title="Tear down"></a>Tear down</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">docker-compose -f daemons/kube-master.yml down</div><div class="line">docker-compose -f daemons/kube-node.yml down</div><div class="line">docker-compose -f daemons/etcd.yml down</div><div class="line"></div><div class="line">docker rm $(docker ps -aq) -f</div><div class="line">reboot</div><div class="line">rm -rf /var/lib/kubelet /srv/etcd /etc/cni /etc/kubernetes /etc/etcd</div></pre></td></tr></table></figure></div><div class="tags"><a href="/tags/笔记/">笔记</a></div><div class="post-share"></div><div class="post-nav"><a href="/2018/01/30/Best Practices for Maintainers/" class="pre">维护者的最佳实践</a><a href="/2018/01/25/kubernetes-ha/" class="next">部署高可用的k8s集群</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Kubernetes安装脚本"><span class="toc-text">Kubernetes安装脚本</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#环境"><span class="toc-text">环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Docker-daemon-config"><span class="toc-text">Docker daemon config</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Install-cfssl"><span class="toc-text">Install cfssl</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Generate-config"><span class="toc-text">Generate config</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Set-Env"><span class="toc-text">Set Env</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Generate-etcd-certificates"><span class="toc-text">Generate etcd certificates</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Generate-kubernete-certificates"><span class="toc-text">Generate kubernete certificates</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Generate-kubernete-configurations"><span class="toc-text">Generate kubernete configurations</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Run-basic-services-on-each-node"><span class="toc-text">Run basic services on each node</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Post-config-cluster"><span class="toc-text">Post-config cluster</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Firewall"><span class="toc-text">Firewall</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Tear-down"><span class="toc-text">Tear down</span></a></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/06/19/Spring Boot Start-up/">Spring Boot 启动速度优化</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/11/phpMyAdmin/">phpMyAdmin</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/16/Let’s Encrypt SSL/">Let's Encrypt 实现站点 SSL</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/12/kubernetes-istio/">kubernetes-istio</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/30/Best Practices for Maintainers/">维护者的最佳实践</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/25/kubenetes-docker/">Kubernetes安装脚本(docker-compose)</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/25/kubernetes-ha/">部署高可用的k8s集群</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/16/Kubernetes-Install/">Kubernetes Install</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/23/hello-world/">Hello World</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/23/first/">第一篇博客</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Kubernetes/">Kubernetes</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/translate/">translate</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/笔记/">笔记</a><span class="category-list-count">3</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/SSL/" style="font-size: 15px;">SSL</a> <a href="/tags/HTTPS/" style="font-size: 15px;">HTTPS</a> <a href="/tags/无题/" style="font-size: 15px;">无题</a> <a href="/tags/翻译/" style="font-size: 15px;">翻译</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/笔记/" style="font-size: 15px;">笔记</a> <a href="/tags/spring-boot/" style="font-size: 15px;">spring boot</a> <a href="/tags/java/" style="font-size: 15px;">java</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a></li></ul></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">Baidu Site Haritası</a> |  <a href="/atom.xml">订阅</a> |  <a href="/about/">关于</a></p><p><span> Copyright &copy;<a href="/." rel="nofollow">张克升.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script type="text/javascript" src="/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.1" async></script></body></html>