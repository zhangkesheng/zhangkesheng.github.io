<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Let's Encrypt 实现站点 SSL | 张克升的个人博客</title><link rel="stylesheet" type="text/css" href="//fonts.neworld.org/css?family=Source+Code+Pro"><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Let's Encrypt 实现站点 SSL</h1><a id="logo" href="/.">张克升的个人博客</a><p class="description">不想当架构师的工程师不是好的程序员</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Search"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">Let's Encrypt 实现站点 SSL</h1><div class="post-meta"><a href="/2018/04/16/Let’s Encrypt SSL/#comments" class="comment-count"></a><p><span class="date">Apr 16, 2018</span><span><a href="/categories/笔记/" class="category">笔记</a></span><span><i id="busuanzi_container_page_pv"><i id="busuanzi_value_page_pv"></i><i>点击</i></i></span></p></div><div class="post-content"><h1 id="Let’s-Encrypt-实现站点-SSL"><a href="#Let’s-Encrypt-实现站点-SSL" class="headerlink" title="Let’s Encrypt 实现站点 SSL"></a>Let’s Encrypt 实现站点 SSL</h1><p>本文介绍如何使用<a href="https://letsencrypt.org/" target="_blank" rel="external">Let’s Encrypt</a>实现网站的https访问</p>
<blockquote>
<p>引用了下列网站的内容:</p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzI5MDcyODM1OA==&amp;mid=2247483846&amp;idx=1&amp;sn=7d26ae40ff50c4ec4d0d9a20a36e5275&amp;chksm=ec1a310fdb6db819847d76043868c5796643cc1bc8eb2c623227d6eb297fb74d9b2a7d9f5ef7#rd" target="_blank" rel="external">免费 SSL：Ubuntu 16.04 配置 Let’s Encrypt 实现站点 SSL</a></p>
<p>[<a href="http://www.cnblogs.com/SzeCheng/p/8075799.html" target="_blank" rel="external">使用Let’s Encrypt加密你的小站</a>]</p>
</blockquote>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p><a href="https://letsencrypt.org/" target="_blank" rel="external">Let’s Encrypt</a>是一个免费并且开源的CA, 且已经获得Mozilla, 微软等主要浏览器厂商的根授信. 它极大低降低DV证书的入门门槛, 进而推进全网的HTTPS化.</p>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>安装Let’s Encrypt的自动部署脚本: Certbot.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 安装nginx, 若已安装, 可跳过</span></div><div class="line">apt-get install nginx</div><div class="line"><span class="comment"># 添加certbot的package repository</span></div><div class="line">add-apt-repository ppa:certbot/certbot</div><div class="line"><span class="comment"># 提示 Press [ENTER] to continue or ctrl-c to cancel adding it, 直接Enter即可</span></div><div class="line"><span class="comment"># 更新数据源</span></div><div class="line">apt-get update</div><div class="line"><span class="comment"># 安装 certbot, 若机器上已有python和nginx, 可以只安装certbot. `apt-get install certbot`</span></div><div class="line">apt-get install python-certbot-nginx</div></pre></td></tr></table></figure>
<h2 id="签发SSL证书"><a href="#签发SSL证书" class="headerlink" title="签发SSL证书"></a>签发SSL证书</h2><p>使用certbot签发证书</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">certbot certonly --standalone --email your@email.com -d yourdomain.com -d test.yourdomain.com</div></pre></td></tr></table></figure>
<p>证书会生成在<code>/etc/letsencrypt/live/yourdomain</code>下, 如有需要, 可自行copy到其他文件夹.</p>
<h2 id="配置nginx"><a href="#配置nginx" class="headerlink" title="配置nginx"></a>配置nginx</h2><p>在nginx目录下创建ssl-test.conf, 内容如下:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    <span class="comment"># SSL configuration</span></div><div class="line"></div><div class="line">    listen 443 ssl;</div><div class="line">    listen [::]:443 ssl;</div><div class="line">    ssl on;</div><div class="line"></div><div class="line">    ssl_certificate   /etc/letsencrypt/live/yourdomain.com/fullchain.pem;</div><div class="line">    ssl_certificate_key  /etc/letsencrypt/live/yourdomain.com/privkey.pem;</div><div class="line">    ssl_session_timeout 5m;</div><div class="line">    ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4;</div><div class="line">    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</div><div class="line">    ssl_prefer_server_ciphers on;</div><div class="line"></div><div class="line">    root /var/www/html;</div><div class="line"></div><div class="line">        <span class="comment"># Add index.php to the list if you are using PHP</span></div><div class="line">        index index.html index.htm index.nginx-debian.html;</div><div class="line"></div><div class="line">        location / &#123;</div><div class="line">                <span class="comment"># First attempt to serve request as file, then</span></div><div class="line">                <span class="comment"># as directory, then fall back to displaying a 404.</span></div><div class="line">                proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</div><div class="line">                proxy_set_header X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</div><div class="line">                proxy_set_header Host <span class="variable">$http_host</span>;</div><div class="line">                try_files <span class="variable">$uri</span> <span class="variable">$uri</span>/ =404;</div><div class="line">        &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>重新启动nginx服务</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nginx -t &amp;&amp; nginx -s reload</div></pre></td></tr></table></figure>
<p>这时候在域名前加https就可以访问了.</p>
<h2 id="添加https访问"><a href="#添加https访问" class="headerlink" title="添加https访问"></a>添加https访问</h2><p>在nginx文件夹下新建一个ssl.conf, 统一配置, 暂时没有用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">ssl on;</div><div class="line">ssl_session_cache shared:SSL:10m;</div><div class="line">ssl_session_timeout 24h;</div><div class="line">ssl_buffer_size 1400;</div><div class="line">ssl_session_tickets off;</div><div class="line"></div><div class="line">ssl_protocols TLSv1 TLSv1.1 TLSv1.2;</div><div class="line"></div><div class="line">ssl_ciphers AES256+EECDH:AES256+EDH:!aNULL;</div><div class="line"># ssl_ciphers &quot;EECDH+AESGCM:EDH+AESGCM:ECDHE-RSA-AES128-GCM-SHA256:AES256+EECDH:DHE-RSA-AES128-GCM-SHA256:AES256+EDH:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES256-SHA256:DHE-RSA-AES128-SHA256:DHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA:ECDHE-RSA-DES-CBC3-SHA:EDH-RSA-DES-CBC3-SHA:AES256-GCM-SHA384:AES128-GCM-SHA256:AES256-SHA256:AES128-SHA256:AES256-SHA:AES128-SHA:DES-CBC3-SHA:HIGH:!aNULL:!eNULL:!EXPORT:!DES:!MD5:!PSK:!RC4&quot;;</div><div class="line">ssl_prefer_server_ciphers on;</div><div class="line"></div><div class="line">ssl_certificate   /etc/letsencrypt/live/yourdomain.com/fullchain.pem;</div><div class="line">ssl_certificate_key  /etc/letsencrypt/live/yourdomain.com/privkey.pem;</div><div class="line"></div><div class="line">#ssl_stapling on;</div><div class="line">#ssl_stapling_verify on;</div><div class="line">#resolver 119.29.29.29 223.5.5.5 223.6.6.6 valid=600s;</div><div class="line">#resolver_timeout 30s;</div><div class="line"></div><div class="line">#spdy_keepalive_timeout 300;</div><div class="line">#spdy_headers_comp 9;</div><div class="line"></div><div class="line">#add_header Strict-Transport-Security max-age=63072000;</div><div class="line">#add_header Strict-Transport-Security &quot;max-age=31536000; includeSubdomains&quot; always;</div><div class="line">add_header X-Frame-Options DENY;</div><div class="line">add_header X-Content-Type-Options nosniff;</div></pre></td></tr></table></figure>
<p>创建一个conf</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">  listen 443 ssl;</div><div class="line">  server_name test.yourdomain.com;</div><div class="line">  ssl on;</div><div class="line">  ssl_certificate   /etc/letsencrypt/live/xiaoshaniu.xin/fullchain.pem;</div><div class="line">  ssl_certificate_key  /etc/letsencrypt/live/xiaoshaniu.xin/privkey.pem;</div><div class="line"></div><div class="line">  client_max_body_size 1G;</div><div class="line">  proxy_set_header        Host            <span class="variable">$host</span>;</div><div class="line">  proxy_set_header        X-Real-IP       <span class="variable">$remote_addr</span>;</div><div class="line">  proxy_set_header        X-Forwarded-For <span class="variable">$proxy_add_x_forwarded_for</span>;</div><div class="line">  location / &#123;</div><div class="line">    proxy_pass http://ip:port;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>仅限https访问, 可以不加</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">server &#123;</div><div class="line">    listen 80;</div><div class="line"></div><div class="line">    server_name test.yourdomain.com;</div><div class="line">    rewrite ^(.*) https://<span class="variable">$server_name</span><span class="variable">$1</span> permanent;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>记得nginx reload</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nginx -t &amp;&amp; nginx -s reload</div></pre></td></tr></table></figure>
<p>至此, 就可以https加密就完成了</p>
<h2 id="自动更新证书"><a href="#自动更新证书" class="headerlink" title="自动更新证书"></a>自动更新证书</h2><p>因为Let’s Encrypt签发的SSL证书有效期只有90天, 所以我们需要在90天内更新证书.</p>
<p>Let’s Encrypt也将自动更新的脚本添加到了<code>/etc/cron.d</code>里, 只需要执行下面的命令验证一下就可以了.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">certbot renew --dry-run</div></pre></td></tr></table></figure>
</div><div class="tags"><a href="/tags/SSL/">SSL</a><a href="/tags/HTTPS/">HTTPS</a></div><div class="post-share"></div><div class="post-nav"><a href="/2018/04/12/kubernetes-istio/" class="next">kubernetes-istio</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Let’s-Encrypt-实现站点-SSL"><span class="toc-text">Let’s Encrypt 实现站点 SSL</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#介绍"><span class="toc-text">介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#安装"><span class="toc-text">安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#签发SSL证书"><span class="toc-text">签发SSL证书</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置nginx"><span class="toc-text">配置nginx</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#添加https访问"><span class="toc-text">添加https访问</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#自动更新证书"><span class="toc-text">自动更新证书</span></a></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/04/16/Let’s Encrypt SSL/">Let's Encrypt 实现站点 SSL</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/12/kubernetes-istio/">kubernetes-istio</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/30/Best Practices for Maintainers/">维护者的最佳实践</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/25/kubenetes-docker/">Kubernetes安装脚本(docker-compose)</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/25/kubernetes-ha/">部署高可用的k8s集群</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/16/Kubernetes-Install/">Kubernetes Install</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/23/first/">第一篇博客</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/08/23/hello-world/">Hello World</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Kubernetes/">Kubernetes</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/translate/">translate</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/笔记/">笔记</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/无题/" style="font-size: 15px;">无题</a> <a href="/tags/SSL/" style="font-size: 15px;">SSL</a> <a href="/tags/HTTPS/" style="font-size: 15px;">HTTPS</a> <a href="/tags/笔记/" style="font-size: 15px;">笔记</a> <a href="/tags/翻译/" style="font-size: 15px;">翻译</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a></li></ul></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">Baidu Site Haritası</a> |  <a href="/atom.xml">订阅</a> |  <a href="/about/">关于</a></p><p>本站总访问量：<i id="busuanzi_container_site_pv"><i id="busuanzi_value_site_pv"></i></i>次</p><p><span> Copyright &copy;<a href="/." rel="nofollow">张克升.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Count by<a href="http://busuanzi.ibruce.info/"> busuanzi.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><script type="text/javascript" src="/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.1" async></script></body></html>