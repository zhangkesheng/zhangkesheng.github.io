<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>kubernetes-istio-v2 | 张克升的个人博客</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=2.0.1"><link rel="stylesheet" type="text/css" href="/css/highlight.css?v=2.0.1"><link rel="Shortcut Icon" href="/favicon.ico"><link rel="bookmark" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">kubernetes-istio-v2</h1><a id="logo" href="/.">张克升的个人博客</a><p class="description">不想当架构师的工程师不是好的程序员</p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a></div><div id="search-form"><div id="result-mask" class="hide"></div><label><input id="search-key" type="text" autocomplete="off" placeholder="Search"></label><div id="result-wrap" class="hide"><div id="search-result"></div></div><div class="hide"><template id="search-tpl"><div class="item"><a href="/{path}" title="{title}"><div class="title">{title}</div><div class="time">{date}</div><div class="tags">{tags}</div></a></div></template></div></div></div><div id="layout" class="layout-g"><div class="layout-l"><div class="content_container"><div class="post"><h1 class="post-title">kubernetes-istio-v2</h1><div class="post-meta"><a href="/2018/06/25/kubernetes-istio-v2/#comments" class="comment-count"></a><p><span class="date">Jun 25, 2018</span><span><a href="/categories/笔记/" class="category">笔记</a></span></p></div><div class="post-content"><h1 id="kubernetes1-10集成istio-8-0"><a href="#kubernetes1-10集成istio-8-0" class="headerlink" title="kubernetes1.10集成istio 8.0"></a>kubernetes1.10集成istio 8.0</h1><p>本来已经部署好istio0.5, 以为升级一下就可以了, 实际操作起来才发现, 中间多了这么多坑.</p>
<blockquote>
<p>istio 0.5的部署请参考<a href="/2018/04/12/kubernetes-istio/">kubernetes-istio</a></p>
</blockquote>
<p>[TOC]</p>
<h2 id="部署istio"><a href="#部署istio" class="headerlink" title="部署istio"></a>部署istio</h2><h3 id="下载最新版安装文件"><a href="#下载最新版安装文件" class="headerlink" title="下载最新版安装文件"></a>下载最新版安装文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -L https://git.io/getLatestIstio | sh -</div></pre></td></tr></table></figure>
<h3 id="helm部署istio"><a href="#helm部署istio" class="headerlink" title="helm部署istio"></a>helm部署istio</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">cd</span> istio-VERSION <span class="comment"># 版本不一样, 文件夹名也不一样</span></div><div class="line"><span class="comment"># 手动注入模式</span></div><div class="line">helm template install/kubernetes/helm/istio --name istio --namespace istio-system --<span class="built_in">set</span> sidecarInjectorWebhook.enabled=<span class="literal">false</span> &gt; <span class="variable">$HOME</span>/istio.yaml</div><div class="line"><span class="comment"># 或自动注入模式, 由于需要修改k8s配置, 所以选择手动</span></div><div class="line"><span class="comment"># helm template install/kubernetes/helm/istio --name istio --namespace istio-system &gt; $HOME/istio.yaml</span></div><div class="line"><span class="comment"># 部署</span></div><div class="line">kubectl create namespace istio-system</div><div class="line">kubectl apply -f <span class="variable">$HOME</span>/istio.yaml</div></pre></td></tr></table></figure>
<h2 id="配置egress"><a href="#配置egress" class="headerlink" title="配置egress"></a>配置egress</h2><p>istio0.8的egressRule与0.5的配置有很大的改变</p>
<h3 id="ServiceEntry"><a href="#ServiceEntry" class="headerlink" title="ServiceEntry"></a>ServiceEntry</h3><p>官方文档上推荐使用这个方式来创建egressRule, 就目前来看, serviceEntry只支持HTTP/HTTPS, TCP类型需要用到之前的egressRule, 但是试了一下,  istio0.5的egressRule配置并不会生效, 这个需要之后验证.</p>
<h3 id="Calling-external-services-directly-直接调用外部服务"><a href="#Calling-external-services-directly-直接调用外部服务" class="headerlink" title="Calling external services directly(直接调用外部服务 )"></a>Calling external services directly(直接调用外部服务 )</h3><p>目前, 采用直接调用外部服务的方式. 不需要配置其他, 只要要修改istio-sidecar-injector configmap即可.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">helm template install/kubernetes/helm/istio --name istio --namespace istio-system --<span class="built_in">set</span> sidecarInjectorWebhook.enabled=<span class="literal">false</span> --<span class="built_in">set</span> global.proxy.includeIPRanges=<span class="string">"172.16.0.0/18"</span> -x templates/sidecar-injector-configmap.yaml | kubectl apply -f -</div></pre></td></tr></table></figure>
<p>istio 0.8 egress rule 文档地址 <a href="https://istio.io/docs/tasks/traffic-management/egress/" target="_blank" rel="external">Control Egress Traffic &gt;&gt;</a></p>
<p>之后的部署及相关配套设施的部署与<a href="/2018/04/12/kubernetes-istio/">kubernetes-istio</a>相同.</p>
<h2 id="INGRESS"><a href="#INGRESS" class="headerlink" title="INGRESS"></a>INGRESS</h2><p>istio0.8 将ingress改为了gateway, 暂时没有使用gateway的功能, 依旧使用的是ingress.</p>
<h2 id="记录坑"><a href="#记录坑" class="headerlink" title="记录坑"></a>记录坑</h2><h3 id="ingress"><a href="#ingress" class="headerlink" title="ingress"></a>ingress</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="attr">apiVersion:</span> <span class="string">extensions/v1beta1</span></div><div class="line"><span class="attr">kind:</span> <span class="string">Ingress</span></div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> <span class="string">INGRESS_NAME</span></div><div class="line"><span class="attr">  namespace:</span> <span class="string">NAMESPACE</span></div><div class="line"><span class="attr">  annotations:</span> <span class="comment">#添加istio annotations</span></div><div class="line">    <span class="string">kubernetes.io/ingress.class:</span> <span class="string">"istio"</span></div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  rules:</span></div><div class="line"><span class="attr">  - host:</span> <span class="string">HOST</span></div><div class="line"><span class="attr">    http:</span></div><div class="line"><span class="attr">      paths:</span></div><div class="line"><span class="attr">      - path:</span> <span class="string">[/contextPath]/.*</span></div><div class="line"><span class="attr">        backend:</span></div><div class="line"><span class="attr">          serviceName:</span> <span class="string">service-name</span></div><div class="line"><span class="attr">          servicePort:</span> <span class="number">80</span></div></pre></td></tr></table></figure>
<p><strong>http.paths.path记得用.<em>, 千万不要只写一个 </em> 号!!! </strong></p>
<p><strong>http.paths.path记得用.<em>, 千万不要只写一个 </em> 号!!! </strong></p>
<p><strong>http.paths.path记得用.<em>, 千万不要只写一个 </em> 号!!! </strong></p>
<h3 id="selector-version"><a href="#selector-version" class="headerlink" title="selector version"></a>selector version</h3><p>selector 添加新的标签, 会导致旧的副本集不会被删除, 也不关联在deployment下, 这样接口访问会有不同版本的问题. 需要在service里添加相应的selector, 或使用istio的路由规则.</p>
</div><div class="tags"><a href="/tags/kubernetes/">kubernetes</a><a href="/tags/istio/">istio</a></div><div class="post-share"></div><div class="post-nav"><a href="/2018/06/29/zookeeper-conformance-principle/" class="pre">zookeeper-conformance-principle</a><a href="/2018/06/19/Spring Boot Start-up/" class="next">Spring Boot 启动速度优化</a></div><div id="comments"></div></div></div></div><div class="layout-r"><div id="sidebar"><div class="search-pla"></div><div id="toc" class="widget"><div class="widget-title"><i class="fa fa-fei">文章目录</i></div><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#kubernetes1-10集成istio-8-0"><span class="toc-text">kubernetes1.10集成istio 8.0</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#部署istio"><span class="toc-text">部署istio</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#下载最新版安装文件"><span class="toc-text">下载最新版安装文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#helm部署istio"><span class="toc-text">helm部署istio</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#配置egress"><span class="toc-text">配置egress</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ServiceEntry"><span class="toc-text">ServiceEntry</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Calling-external-services-directly-直接调用外部服务"><span class="toc-text">Calling external services directly(直接调用外部服务 )</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#INGRESS"><span class="toc-text">INGRESS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#记录坑"><span class="toc-text">记录坑</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ingress"><span class="toc-text">ingress</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#selector-version"><span class="toc-text">selector version</span></a></li></ol></li></ol></li></ol></div><div class="widget"><div class="widget-title"><i class="fa fa-xie"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/06/29/zookeeper-conformance-principle/">zookeeper-conformance-principle</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/25/kubernetes-istio-v2/">kubernetes-istio-v2</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/19/Spring Boot Start-up/">Spring Boot 启动速度优化</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/11/phpMyAdmin/">phpMyAdmin</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/16/Let’s Encrypt SSL/">Let's Encrypt 实现站点 SSL</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/04/12/kubernetes-istio/">kubernetes-istio</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/30/Best Practices for Maintainers/">维护者的最佳实践</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/25/kubenetes-docker/">Kubernetes安装脚本(docker-compose)</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/01/25/kubernetes-ha/">部署高可用的k8s集群</a></li><li class="post-list-item"><a class="post-list-link" href="/2017/11/16/Kubernetes-Install/">Kubernetes Install</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-gui"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Kubernetes/">Kubernetes</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/translate/">translate</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/笔记/">笔记</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/转载/">转载</a><span class="category-list-count">1</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-biao"> 标签</i></div><div class="tagcloud"><a href="/tags/spring-boot/" style="font-size: 15px;">spring boot</a> <a href="/tags/笔记/" style="font-size: 15px;">笔记</a> <a href="/tags/HTTPS/" style="font-size: 15px;">HTTPS</a> <a href="/tags/无题/" style="font-size: 15px;">无题</a> <a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/istio/" style="font-size: 15px;">istio</a> <a href="/tags/SSL/" style="font-size: 15px;">SSL</a> <a href="/tags/java/" style="font-size: 15px;">java</a> <a href="/tags/翻译/" style="font-size: 15px;">翻译</a> <a href="/tags/docker/" style="font-size: 15px;">docker</a> <a href="/tags/mysql/" style="font-size: 15px;">mysql</a> <a href="/tags/zookeeper/" style="font-size: 15px;">zookeeper</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-archive"> 归档</i></div><ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">六月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/04/">四月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a></li></ul></div></div></div></div><a id="totop" href="#top"></a><div id="footer"><div class="footer-info"><p><a href="/baidusitemap.xml">Baidu Site Haritası</a> |  <a href="/atom.xml">订阅</a> |  <a href="/about/">关于</a></p><p><span> Copyright &copy;<a href="/." rel="nofollow">张克升.</a></span><span> Theme by<a rel="nofollow" target="_blank" href="https://github.com/chaooo/hexo-theme-BlueLake"> BlueLake.</a></span><span> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a></span></p></div></div></div><script type="text/javascript" src="/js/search.json.js?v=2.0.1"></script><script type="text/javascript" src="/js/toctotop.js?v=2.0.1" async></script></body></html>